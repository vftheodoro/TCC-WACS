<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - WACS</title>
    <link rel="stylesheet" href="../public/css/styles.css">
    <link rel="stylesheet" href="../public/css/core.css">
    <link rel="stylesheet" href="../public/css/theme-switch.css">
    <link rel="stylesheet" href="../public/css/navbar-modern.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="../public/images/logo-light.png" type="image/png">
    <style>
        /* Estilos da navbar compacta */
        #main-nav {
            min-height: 45px;
        }
        
        .navbar-content {
            padding: 0.35rem 0;
        }
        
        .logo img {
            width: 28px;
            height: auto;
        }
        
        .logo {
            margin-right: 0.5rem;
        }
        
        .logo-text {
            font-size: 1.1rem;
        }
        
        .nav-menu {
            margin-left: 0;
        }
        
        .nav-links {
            gap: 0.25rem;
        }
        
        .nav-links li {
            margin: 0 0.2rem;
        }
        
        .nav-links li:first-child {
            margin-left: 0;
        }
        
        .nav-links li a {
            padding: 0.2rem 0.4rem;
            height: 1.8rem;
            font-size: 0.85rem;
        }
        
        .nav-actions {
            gap: 0.35rem;
        }
        
        .theme-toggle {
            transform: scale(0.8);
        }
        
        .logout-btn {
            padding: 0.2rem 0.65rem;
            font-size: 0.8rem;
        }
        
        .menu-toggle {
            width: 20px;
            height: 14px;
        }
        
        .menu-toggle span {
            height: 1.5px;
        }

        /* Ajuste para o espaço do dashboard */
        .dashboard-container {
            padding-top: 45px;
            min-height: calc(100vh - 45px);
            background: var(--background-color, #fff);
        }
        
        body.dark-theme .dashboard-container {
            background: var(--dark-background, #121212);
        }
        
        .dashboard-header {
            background: var(--accent-color, #e0eaff);
            padding: 2rem 0;
        }
        
        body.dark-theme .dashboard-header {
            background: var(--dark-accent, #1E293B);
        }
        
        .dashboard-header h1 {
            color: var(--primary-color, #0055b3);
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
        }
        
        body.dark-theme .dashboard-header h1 {
            color: var(--dark-primary, #4A90E2);
        }
        
        .dashboard-header p {
            color: var(--text-light, #4b5563);
        }
        
        body.dark-theme .dashboard-header p {
            color: var(--dark-text-light, #94a3b8);
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .stat-card {
            background: var(--background-color, #fff);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            transition: transform 0.3s ease;
        }
        
        body.dark-theme .stat-card {
            background: var(--dark-card, #1e1e2d);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--accent-color, #e0eaff);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            color: var(--primary-color, #0055b3);
            font-size: 1.5rem;
        }
        
        body.dark-theme .stat-icon {
            background: var(--dark-accent, #1E293B);
            color: var(--dark-primary, #4A90E2);
        }
        
        .stat-content h3 {
            font-size: 0.9rem;
            color: var(--text-light, #4b5563);
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        
        body.dark-theme .stat-content h3 {
            color: var(--dark-text-light, #94a3b8);
        }
        
        .stat-content p {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color, #1f2937);
            margin: 0;
        }
        
        body.dark-theme .stat-content p {
            color: var(--dark-text, #e2e8f0);
        }
        
        .dashboard-content {
            padding: 2rem 0;
        }
        
        .dashboard-section {
            margin-bottom: 3rem;
        }
        
        .dashboard-section h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--text-color, #1f2937);
        }
        
        body.dark-theme .dashboard-section h2 {
            color: var(--dark-text, #e2e8f0);
        }
        
        .map-container {
            height: 400px;
            background: #f5f5f5;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light, #4b5563);
            font-size: 1.1rem;
        }
        
        body.dark-theme .map-container {
            background: var(--dark-card, #1e1e2d);
            color: var(--dark-text-light, #94a3b8);
        }
        
        .locations-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .location-card {
            background: var(--background-color, #fff);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        
        body.dark-theme .location-card {
            background: var(--dark-card, #1e1e2d);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .location-card:hover {
            transform: translateY(-5px);
        }
        
        .location-image {
            height: 160px;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            overflow: hidden;
        }
        
        .location-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .location-card:hover .location-image img {
            transform: scale(1.05);
        }
        
        body.dark-theme .location-image {
            background: #2d3748;
            color: #718096;
        }
        
        .location-details {
            padding: 1.5rem;
        }
        
        .location-details h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--text-color, #1f2937);
        }
        
        body.dark-theme .location-details h3 {
            color: var(--dark-text, #e2e8f0);
        }
        
        .location-details p {
            color: var(--text-light, #4b5563);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        body.dark-theme .location-details p {
            color: var(--dark-text-light, #94a3b8);
        }
        
        .location-rating {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
        }
        
        .location-rating i {
            color: #fbbf24;
            font-size: 0.9rem;
            margin-right: 0.25rem;
        }
        
        .location-rating span {
            margin-left: 0.5rem;
            color: var(--text-light, #4b5563);
            font-size: 0.9rem;
        }
        
        body.dark-theme .location-rating span {
            color: var(--dark-text-light, #94a3b8);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            margin-top: 20px;
        }
        
        .user-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--accent-color, #e0eaff);
            color: var(--primary-color, #0055b3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 1rem;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            text-decoration: none;
        }
        
        .user-avatar:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        body.dark-theme .user-avatar {
            background: var(--dark-accent, #1E293B);
            color: var(--dark-primary, #4A90E2);
        }
        
        body.dark-theme .user-avatar:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .user-details h2 {
            margin-bottom: 0.25rem;
        }
        
        .user-details p {
            color: var(--text-light, #4b5563);
            margin: 0;
            margin-bottom: 0.5rem;
        }
        
        body.dark-theme .user-details p {
            color: var(--dark-text-light, #94a3b8);
        }
        
        .profile-link {
            display: inline-flex;
            align-items: center;
            color: var(--primary-color, #0055b3);
            font-size: 0.875rem;
            text-decoration: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        
        .profile-link i {
            margin-right: 0.25rem;
        }
        
        .profile-link:hover {
            background-color: var(--accent-color, #e0eaff);
            text-decoration: none;
        }
        
        body.dark-theme .profile-link {
            color: var(--dark-primary, #4A90E2);
        }
        
        body.dark-theme .profile-link:hover {
            background-color: var(--dark-accent, #1E293B);
        }
        
        .logout-btn {
            background: transparent;
            color: var(--primary-color, #0055b3);
            border: 1px solid var(--primary-color, #0055b3);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: auto;
        }
        
        body.dark-theme .logout-btn {
            color: var(--dark-primary, #4A90E2);
            border-color: var(--dark-primary, #4A90E2);
        }
        
        .logout-btn:hover {
            background: var(--primary-color, #0055b3);
            color: white;
        }
        
        body.dark-theme .logout-btn:hover {
            background: var(--dark-primary, #4A90E2);
            color: white;
        }
        
        .add-location-btn {
            display: inline-flex;
            align-items: center;
            background: var(--primary-color, #0055b3);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        
        body.dark-theme .add-location-btn {
            background: var(--dark-primary, #4A90E2);
        }
        
        .add-location-btn i {
            margin-right: 0.5rem;
        }
        
        .add-location-btn:hover {
            background: var(--primary-hover, #0066d6);
            transform: translateY(-2px);
        }

        /* Estilos para o menu mobile */
        .mobile-menu {
            padding: 0.5rem;
            margin-top: 0.2rem;
        }
        
        .nav-links-mobile {
            margin: 0 0 0.5rem 0;
        }
        
        .nav-links-mobile li {
            margin-bottom: 0.25rem;
        }
        
        .nav-links-mobile a {
            padding: 0.25rem 0.4rem;
            font-size: 0.85rem;
        }
        
        .download-btn-mobile {
            padding: 0.35rem;
            font-size: 0.8rem;
        }
        
        /* Media queries para telas pequenas */
        @media (max-width: 400px) {
            .logo-text {
                display: none;
            }
            
            .nav-links li a {
                padding: 0.2rem 0.3rem;
            }
        }

        /* Centralização da navbar */
        #main-nav .container {
            display: flex;
            justify-content: center;
        }
        
        .navbar-content {
            width: 100%;
            max-width: 900px;
            justify-content: space-between;
        }
        
        @media (max-width: 960px) {
            .navbar-content {
                max-width: 100%;
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }

        /* Estilos para o modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
        }
        
        .modal-content {
            background-color: var(--background-color, #fff);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 600px;
            position: relative;
            animation: modalFadeIn 0.3s ease;
        }
        
        body.dark-theme .modal-content {
            background-color: var(--dark-card, #1e1e2d);
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes modalFadeIn {
            from {opacity: 0; transform: translateY(-20px);}
            to {opacity: 1; transform: translateY(0);}
        }
        
        .close-modal {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            color: var(--text-light, #4b5563);
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        body.dark-theme .close-modal {
            color: var(--dark-text-light, #94a3b8);
        }
        
        .close-modal:hover {
            color: var(--primary-color, #0055b3);
        }
        
        body.dark-theme .close-modal:hover {
            color: var(--dark-primary, #4A90E2);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color, #1f2937);
        }
        
        body.dark-theme .form-group label {
            color: var(--dark-text, #e2e8f0);
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color, #d1d5db);
            border-radius: 8px;
            background: var(--input-bg, #f9fafb);
            color: var(--text-color, #1f2937);
            font-family: 'Inter', sans-serif;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        body.dark-theme .form-group input,
        body.dark-theme .form-group textarea {
            border-color: var(--dark-border, #2d3748);
            background: var(--dark-input-bg, #1a1a2e);
            color: var(--dark-text, #e2e8f0);
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color, #0055b3);
            box-shadow: 0 0 0 3px rgba(0, 85, 179, 0.1);
        }
        
        body.dark-theme .form-group input:focus,
        body.dark-theme .form-group textarea:focus {
            border-color: var(--dark-primary, #4A90E2);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* Estilos para o mapa no formulário */
        .location-map-selector {
            width: 100%;
            height: 300px;
            background-color: #f1f1f1;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        body.dark-theme .location-map-selector {
            background-color: #1a1a2e;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .map-instructions {
            font-size: 0.875rem;
            color: var(--text-light, #4b5563);
            margin-bottom: 1rem;
            font-style: italic;
        }
        
        body.dark-theme .map-instructions {
            color: var(--dark-text-light, #94a3b8);
        }
        
        .coordinates-fields {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .coordinate-field {
            flex: 1;
        }
        
        .coordinate-field label {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .coordinate-field input {
            background-color: var(--accent-color, #e0eaff);
            font-family: monospace;
            text-align: center;
        }
        
        body.dark-theme .coordinate-field input {
            background-color: var(--dark-accent, #1E293B);
        }
        
        .map-marker-pulse {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color, #0055b3);
            position: absolute;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        
        .map-marker-pulse:before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: rgba(0, 85, 179, 0.4);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }
        
        .submit-btn {
            background: var(--primary-color, #0055b3);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            width: 100%;
        }
        
        body.dark-theme .submit-btn {
            background: var(--dark-primary, #4A90E2);
        }
        
        .submit-btn:hover {
            background: var(--primary-hover, #0066d6);
            transform: translateY(-2px);
        }
        
        /* Mensagens de feedback */
        .no-locations, .load-error {
            padding: 2rem;
            text-align: center;
            background: var(--accent-color, #e0eaff);
            border-radius: 12px;
            color: var(--text-color, #1f2937);
            width: 100%;
            margin-bottom: 1.5rem;
        }
        
        body.dark-theme .no-locations, 
        body.dark-theme .load-error {
            background: var(--dark-accent, #1E293B);
            color: var(--dark-text, #e2e8f0);
        }
        
        .load-error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        body.dark-theme .load-error {
            background: #7f1d1d;
            color: #fecaca;
        }
        
        /* Estilos para a janela de informações do mapa */
        .map-info-window {
            padding: 8px;
            max-width: 300px;
        }
        
        .map-info-window h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
            color: var(--primary-color, #0055b3);
        }
        
        .map-info-window p {
            margin: 0 0 6px 0;
            font-size: 14px;
            color: var(--text-color, #1f2937);
        }
        
        body.dark-theme .map-info-window {
            background-color: var(--dark-card, #1e1e2d);
            color: var(--dark-text, #e2e8f0);
        }
        
        /* Estilos para o sistema de avaliação */
        .rating-stars {
            display: flex;
            gap: 0.5rem;
            font-size: 1.5rem;
            margin: 0.5rem 0;
        }
        
        .rating-stars i {
            cursor: pointer;
            color: #d1d5db;
            transition: all 0.2s ease;
        }
        
        body.dark-theme .rating-stars i {
            color: #4b5563;
        }
        
        .rating-stars i:hover,
        .rating-stars i.fas {
            color: #fbbf24;
        }
        
        .rating-stars i:hover ~ i {
            color: #d1d5db;
        }
        
        body.dark-theme .rating-stars i:hover ~ i {
            color: #4b5563;
        }
        
        #locationToRate {
            background-color: var(--accent-color, #e0eaff);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        body.dark-theme #locationToRate {
            background-color: var(--dark-accent, #1E293B);
        }
        
        #locationToRate h3 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            color: var(--primary-color, #0055b3);
        }
        
        body.dark-theme #locationToRate h3 {
            color: var(--dark-primary, #4A90E2);
        }
        
        #locationToRate p {
            margin: 0.25rem 0;
            color: var(--text-light, #4b5563);
        }
        
        body.dark-theme #locationToRate p {
            color: var(--dark-text-light, #94a3b8);
        }
        
        /* Estilos para reviews em cards de locais */
        .location-reviews {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color, #e5e7eb);
        }
        
        body.dark-theme .location-reviews {
            border-color: var(--dark-border, #2d3748);
        }
        
        .review-item {
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px dashed var(--border-color, #e5e7eb);
        }
        
        body.dark-theme .review-item {
            border-color: var(--dark-border, #2d3748);
        }
        
        .review-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        
        .review-author {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-color, #1f2937);
        }
        
        body.dark-theme .review-author {
            color: var(--dark-text, #e2e8f0);
        }
        
        .review-date {
            font-size: 0.75rem;
            color: var(--text-light, #6b7280);
        }
        
        body.dark-theme .review-date {
            color: var(--dark-text-light, #94a3b8);
        }
        
        .review-stars {
            display: flex;
            gap: 0.1rem;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }
        
        .review-stars i.fas {
            color: #fbbf24;
        }
        
        .review-stars i.far {
            color: #d1d5db;
        }
        
        body.dark-theme .review-stars i.far {
            color: #4b5563;
        }
        
        .review-text {
            font-size: 0.875rem;
            color: var(--text-light, #4b5563);
            margin: 0.25rem 0 0 0;
        }
        
        body.dark-theme .review-text {
            color: var(--dark-text-light, #94a3b8);
        }
        
        .rate-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--accent-color, #e0eaff);
            color: var(--primary-color, #0055b3);
            border: none;
            padding: 0.35rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 0.5rem;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .rate-button {
            background-color: var(--dark-accent, #1E293B);
            color: var(--dark-primary, #4A90E2);
        }
        
        .rate-button:hover {
            background-color: var(--primary-color, #0055b3);
            color: white;
        }
        
        body.dark-theme .rate-button:hover {
            background-color: var(--dark-primary, #4A90E2);
            color: white;
        }
        
        .rate-button i {
            margin-right: 0.25rem;
        }
        
        .review-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .show-reviews-button {
            background: none;
            border: none;
            color: var(--primary-color, #0055b3);
            font-size: 0.875rem;
            cursor: pointer;
            padding: 0;
            text-decoration: underline;
        }
        
        body.dark-theme .show-reviews-button {
            color: var(--dark-primary, #4A90E2);
        }
        
        /* Estilos para a última avaliação */
        .last-review {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color, #e5e7eb);
        }
        
        body.dark-theme .last-review {
            border-color: var(--dark-border, #2d3748);
        }
        
        .last-review-content {
            background: var(--accent-color, #e0eaff);
            padding: 0.75rem;
            border-radius: 8px;
        }
        
        body.dark-theme .last-review-content {
            background: var(--dark-accent, #1E293B);
        }
        
        .last-review .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .last-review .review-author {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-color, #1f2937);
        }
        
        body.dark-theme .last-review .review-author {
            color: var(--dark-text, #e2e8f0);
        }
        
        .last-review .review-date {
            font-size: 0.75rem;
            color: var(--text-light, #6b7280);
        }
        
        body.dark-theme .last-review .review-date {
            color: var(--dark-text-light, #94a3b8);
        }
        
        .last-review .review-stars {
            margin-bottom: 0.5rem;
        }
        
        .last-review .review-text {
            font-size: 0.875rem;
            color: var(--text-light, #4b5563);
            margin: 0;
            line-height: 1.4;
        }
        
        body.dark-theme .last-review .review-text {
            color: var(--dark-text-light, #94a3b8);
        }
        
        .no-reviews {
            font-size: 0.875rem;
            color: var(--text-light, #6b7280);
            font-style: italic;
            text-align: center;
            padding: 0.5rem;
        }
        
        body.dark-theme .no-reviews {
            color: var(--dark-text-light, #94a3b8);
        }
        
        .review-error {
            font-size: 0.875rem;
            color: #dc2626;
            text-align: center;
            padding: 0.5rem;
        }
        
        body.dark-theme .review-error {
            color: #f87171;
        }
        
        /* Estilos para a lista de todas as avaliações */
        .all-reviews-list {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 1rem;
        }
        
        .all-reviews-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .all-reviews-list::-webkit-scrollbar-track {
            background: var(--accent-color, #e0eaff);
            border-radius: 4px;
        }
        
        .all-reviews-list::-webkit-scrollbar-thumb {
            background: var(--primary-color, #0055b3);
            border-radius: 4px;
        }
        
        body.dark-theme .all-reviews-list::-webkit-scrollbar-track {
            background: var(--dark-accent, #1E293B);
        }
        
        body.dark-theme .all-reviews-list::-webkit-scrollbar-thumb {
            background: var(--dark-primary, #4A90E2);
        }
        
        .review-item-full {
            background: var(--accent-color, #e0eaff);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        body.dark-theme .review-item-full {
            background: var(--dark-accent, #1E293B);
        }
        
        .review-item-full:last-child {
            margin-bottom: 0;
        }
        
        .review-item-full .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .review-item-full .review-author {
            font-weight: 600;
            color: var(--text-color, #1f2937);
        }
        
        body.dark-theme .review-item-full .review-author {
            color: var(--dark-text, #e2e8f0);
        }
        
        .review-item-full .review-date {
            font-size: 0.875rem;
            color: var(--text-light, #6b7280);
        }
        
        body.dark-theme .review-item-full .review-date {
            color: var(--dark-text-light, #94a3b8);
        }
        
        .review-item-full .review-stars {
            margin-bottom: 0.5rem;
        }
        
        .review-item-full .review-text {
            color: var(--text-light, #4b5563);
            line-height: 1.5;
        }
        
        body.dark-theme .review-item-full .review-text {
            color: var(--dark-text-light, #94a3b8);
        }
        
        .view-all-reviews-btn {
            display: inline-flex;
            align-items: center;
            background: none;
            border: none;
            color: var(--primary-color, #0055b3);
            font-size: 0.875rem;
            cursor: pointer;
            padding: 0.25rem 0;
            margin-top: 0.5rem;
            transition: color 0.3s ease;
        }
        
        body.dark-theme .view-all-reviews-btn {
            color: var(--dark-primary, #4A90E2);
        }
        
        .view-all-reviews-btn:hover {
            text-decoration: underline;
        }
        
        .view-all-reviews-btn i {
            margin-left: 0.25rem;
        }
        
        /* Estilos para o Chat */
        .chat-container {
            background: var(--background-color, #fff);
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 400px;
            margin-bottom: 2rem;
        }
        
        body.dark-theme .chat-container {
            background: var(--dark-card, #1e1e2d);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: var(--accent-color, #e0eaff);
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary-color, #0055b3);
            border-radius: 3px;
        }
        
        body.dark-theme .chat-messages::-webkit-scrollbar-track {
            background: var(--dark-accent, #1E293B);
        }
        
        body.dark-theme .chat-messages::-webkit-scrollbar-thumb {
            background: var(--dark-primary, #4A90E2);
        }
        
        .chat-message {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            max-width: 80%;
            position: relative;
            word-break: break-word;
            display: flex;
            flex-direction: column;
        }
        
        .chat-message.sent {
            background-color: var(--primary-color, #0055b3);
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.received {
            background-color: var(--accent-color, #e0eaff);
            color: var(--text-color, #1f2937);
            align-self: flex-start;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        body.dark-theme .chat-message.sent {
            background-color: var(--dark-primary, #4A90E2);
        }
        
        body.dark-theme .chat-message.received {
            background-color: var(--dark-accent, #1E293B);
            color: var(--dark-text, #e2e8f0);
        }
        
        .chat-message .sender-info {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .chat-message .message-content {
            position: relative;
            width: 100%;
        }
        
        .chat-message .message-text {
            margin: 0;
            line-height: 1.4;
        }
        
        .chat-message .message-time {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 0.25rem;
            text-align: right;
        }
        
        .chat-message .sender-photo {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 0.5rem;
            background-size: cover;
            background-position: center;
            background-color: var(--primary-color, #0055b3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .chat-message .sender-name {
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .chat-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light, #6b7280);
            height: 100%;
            font-size: 0.9rem;
        }
        
        body.dark-theme .chat-loading {
            color: var(--dark-text-light, #94a3b8);
        }
        
        .chat-loading i {
            margin-right: 0.5rem;
        }
        
        .chat-input-container {
            display: flex;
            padding: 0.75rem;
            border-top: 1px solid var(--border-color, #d1d5db);
            background-color: var(--background-color, #fff);
        }
        
        body.dark-theme .chat-input-container {
            border-color: var(--dark-border, #2d3748);
            background-color: var(--dark-card, #1e1e2d);
        }
        
        #chatMessageInput {
            flex: 1;
            border: 1px solid var(--border-color, #d1d5db);
            border-radius: 8px;
            padding: 0.75rem;
            resize: none;
            background-color: var(--input-bg, #f9fafb);
            color: var(--text-color, #1f2937);
            font-family: 'Inter', sans-serif;
            transition: border-color 0.3s ease;
        }
        
        body.dark-theme #chatMessageInput {
            border-color: var(--dark-border, #2d3748);
            background-color: var(--dark-input-bg, #1a1a2e);
            color: var(--dark-text, #e2e8f0);
        }
        
        #chatMessageInput:focus {
            outline: none;
            border-color: var(--primary-color, #0055b3);
            box-shadow: 0 0 0 3px rgba(0, 85, 179, 0.1);
        }
        
        body.dark-theme #chatMessageInput:focus {
            border-color: var(--dark-primary, #4A90E2);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }
        
        .chat-send-btn {
            margin-left: 0.75rem;
            background-color: var(--primary-color, #0055b3);
            color: white;
            border: none;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .chat-send-btn {
            background-color: var(--dark-primary, #4A90E2);
        }
        
        .chat-send-btn:hover {
            background-color: var(--primary-hover, #0066d6);
            transform: translateY(-2px);
        }
        
        .chat-date-separator {
            text-align: center;
            margin: 1rem 0;
            position: relative;
            font-size: 0.75rem;
            color: var(--text-light, #6b7280);
        }
        
        body.dark-theme .chat-date-separator {
            color: var(--dark-text-light, #94a3b8);
        }
        
        .chat-date-separator:before,
        .chat-date-separator:after {
            content: '';
            position: absolute;
            height: 1px;
            background-color: var(--border-color, #d1d5db);
            top: 50%;
            width: calc(50% - 60px);
        }
        
        .chat-date-separator:before {
            left: 0;
        }
        
        .chat-date-separator:after {
            right: 0;
        }
        
        body.dark-theme .chat-date-separator:before,
        body.dark-theme .chat-date-separator:after {
            background-color: var(--dark-border, #2d3748);
        }
        
        .system-message {
            text-align: center;
            color: var(--text-light, #6b7280);
            font-size: 0.8rem;
            margin: 0.5rem 0;
            font-style: italic;
        }
        
        body.dark-theme .system-message {
            color: var(--dark-text-light, #94a3b8);
        }

        .accessibility-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .accessibility-option {
            position: relative;
            cursor: pointer;
        }

        .accessibility-option input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .option-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background-color: var(--accent-color, #e0eaff);
            border: 2px solid transparent;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .option-content i {
            font-size: 1.5rem;
            color: var(--primary-color, #0055b3);
        }

        .option-content span {
            font-size: 0.9rem;
            color: var(--text-color, #1f2937);
        }

        .accessibility-option:hover .option-content {
            background-color: var(--primary-color, #0055b3);
        }

        .accessibility-option:hover .option-content i,
        .accessibility-option:hover .option-content span {
            color: white;
        }

        .accessibility-option input:checked + .option-content {
            background-color: var(--primary-color, #0055b3);
            border-color: var(--primary-color, #0055b3);
        }

        .accessibility-option input:checked + .option-content i,
        .accessibility-option input:checked + .option-content span {
            color: white;
        }

        body.dark-theme .option-content {
            background-color: var(--dark-accent, #1E293B);
        }

        body.dark-theme .option-content i {
            color: var(--dark-primary, #4A90E2);
        }

        body.dark-theme .option-content span {
            color: var(--dark-text, #e2e8f0);
        }

        body.dark-theme .accessibility-option:hover .option-content {
            background-color: var(--dark-primary, #4A90E2);
        }

        body.dark-theme .accessibility-option input:checked + .option-content {
            background-color: var(--dark-primary, #4A90E2);
            border-color: var(--dark-primary, #4A90E2);
        }

        .accessibility-features {
            display: flex;
            gap: 0.5rem;
            margin: 0.5rem 0;
            flex-wrap: wrap;
        }
        
        .accessibility-features i {
            font-size: 1.2rem;
            color: var(--primary-color, #0055b3);
            background: var(--accent-color, #e0eaff);
            padding: 0.5rem;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .accessibility-features i {
            color: var(--dark-primary, #4A90E2);
            background: var(--dark-accent, #1E293B);
        }
        
        .accessibility-features i:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .accessibility-ratings {
            display: grid;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .accessibility-rating-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--accent-color, #e0eaff);
            border-radius: 8px;
        }

        body.dark-theme .accessibility-rating-item {
            background: var(--dark-accent, #1E293B);
        }

        .accessibility-rating-item i.feature-icon {
            font-size: 1.5rem;
            color: var(--primary-color, #0055b3);
            width: 2rem;
            text-align: center;
        }

        body.dark-theme .accessibility-rating-item i.feature-icon {
            color: var(--dark-primary, #4A90E2);
        }

        .accessibility-rating-item .feature-name {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text-color, #1f2937);
        }

        body.dark-theme .accessibility-rating-item .feature-name {
            color: var(--dark-text, #e2e8f0);
        }

        .accessibility-rating-item .feature-stars {
            display: flex;
            gap: 0.25rem;
        }

        .accessibility-rating-item .feature-stars i {
            cursor: pointer;
            color: #d1d5db;
            transition: all 0.2s ease;
        }

        body.dark-theme .accessibility-rating-item .feature-stars i {
            color: #4b5563;
        }

        .accessibility-rating-item .feature-stars i:hover,
        .accessibility-rating-item .feature-stars i.fas {
            color: #fbbf24;
        }

        .feature-ratings {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color, #e5e7eb);
        }

        body.dark-theme .feature-ratings {
            border-color: var(--dark-border, #2d3748);
        }

        .feature-rating-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: var(--accent-color, #e0eaff);
            border-radius: 6px;
        }

        body.dark-theme .feature-rating-item {
            background: var(--dark-accent, #1E293B);
        }

        .feature-rating-item i {
            font-size: 1.2rem;
            color: var(--primary-color, #0055b3);
            width: 1.5rem;
            text-align: center;
        }

        body.dark-theme .feature-rating-item i {
            color: var(--dark-primary, #4A90E2);
        }

        .feature-rating-item span {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text-color, #1f2937);
        }

        body.dark-theme .feature-rating-item span {
            color: var(--dark-text, #e2e8f0);
        }

        .feature-rating-item .feature-stars {
            display: flex;
            gap: 0.1rem;
        }

        .feature-rating-item .feature-stars i {
            font-size: 0.9rem;
            color: #fbbf24;
        }

        .feature-averages {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--accent-color, #e0eaff);
            border-radius: 8px;
        }

        body.dark-theme .feature-averages {
            background: var(--dark-accent, #1E293B);
        }

        .feature-average {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .feature-average:last-child {
            margin-bottom: 0;
        }

        .feature-average span {
            font-size: 0.9rem;
            color: var(--text-color, #1f2937);
        }

        body.dark-theme .feature-average span {
            color: var(--dark-text, #e2e8f0);
        }

        .feature-average .feature-stars {
            display: flex;
            gap: 0.1rem;
        }

        .feature-average .feature-stars i {
            font-size: 0.9rem;
            color: #fbbf24;
        }

        body.dark-theme .chat-message.sent .sender-photo {
            background-color: white;
            color: var(--dark-primary, #4A90E2);
        }

        .chat-message .sender-name {
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        /* Estilos para deletar mensagens */
        .message-delete-btn {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.6);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 0.8rem;
        }
        
        .chat-message.received .message-delete-btn {
            color: rgba(0, 0, 0, 0.5);
        }
        
        .chat-message:hover .message-delete-btn {
            opacity: 1;
        }
        
        .message-delete-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .chat-message.received .message-delete-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: rgba(0, 0, 0, 0.8);
        }
        
        /* Mensagem apagada */
        .deleted-message {
            font-style: italic;
            opacity: 0.7;
        }
        
        .deleted-message i {
            margin-right: 0.25rem;
        }
        
        body.dark-theme .chat-message .message-delete-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Estilos para as avaliações detalhadas de acessibilidade */
        .feature-ratings-detail {
            margin-top: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .feature-rating-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background-color: var(--accent-color, #e0eaff);
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        body.dark-theme .feature-rating-badge {
            background-color: var(--dark-accent, #1E293B);
        }
        
        .feature-rating-badge i {
            color: var(--primary-color, #0055b3);
            font-size: 0.85rem;
        }
        
        body.dark-theme .feature-rating-badge i {
            color: var(--dark-primary, #4A90E2);
        }
        
        .feature-rating-badge .feature-stars {
            display: flex;
            color: #fbbf24;
            margin-left: 0.3rem;
        }
        
        .feature-rating-badge .feature-name {
            font-weight: 500;
        }

        /* Estilos para o input de arquivo */
        .form-group input[type="file"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px dashed var(--border-color, #d1d5db);
            border-radius: 8px;
            background: var(--input-bg, #f9fafb);
            color: var(--text-color, #1f2937);
            cursor: pointer;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }

        .form-group input[type="file"]:hover {
            border-color: var(--primary-color, #0055b3);
            background-color: rgba(0, 85, 179, 0.05);
        }

        body.dark-theme .form-group input[type="file"] {
            border-color: var(--dark-border, #2d3748);
            background: var(--dark-input-bg, #1a1a2e);
            color: var(--dark-text, #e2e8f0);
        }

        body.dark-theme .form-group input[type="file"]:hover {
            border-color: var(--dark-primary, #4A90E2);
            background-color: rgba(74, 144, 226, 0.1);
        }

        .form-group .form-text {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: var(--text-muted, #6b7280);
        }

        body.dark-theme .form-group .form-text {
            color: var(--dark-text-muted, #9ca3af);
        }

        /* Estilos para o botão de submit durante o carregamento */
        .submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .submit-btn .fa-spinner {
            margin-right: 0.5rem;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fa-spin {
            animation: spin 1s linear infinite;
        }

        /* Estilos para o modal de perfil do usuário */
        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .user-profile-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--accent-color, #e0eaff);
            color: var(--primary-color, #0055b3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
        }

        body.dark-theme .user-profile-photo {
            background: var(--dark-accent, #1a1a2e);
            color: var(--dark-primary, #4A90E2);
        }

        .user-profile-info h2 {
            margin: 0;
            color: var(--text-color, #1f2937);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        .admin-badge {
            margin-left: 8px;
            padding: 2px 8px;
            background-color: #4CAF50;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        body.dark-theme .admin-badge {
            background-color: #2E7D32;
        }

        .user-profile-info p {
            margin: 0.5rem 0 0;
            color: var(--text-light, #6b7280);
            font-size: 0.9rem;
        }

        .user-profile-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .action-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .chat-btn {
            background: var(--primary-color, #0055b3);
            color: white;
        }

        .friend-btn {
            background: var(--accent-color, #e0eaff);
            color: var(--primary-color, #0055b3);
        }

        .chat-btn:hover {
            background: var(--primary-dark, #004494);
        }

        .friend-btn:hover {
            background: var(--accent-dark, #ccd9ff);
        }

        body.dark-theme .chat-btn {
            background: var(--dark-primary, #4A90E2);
        }

        body.dark-theme .friend-btn {
            background: var(--dark-accent, #1a1a2e);
            color: var(--dark-primary, #4A90E2);
        }

        .contribution-stats {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .stat {
            flex: 1;
            text-align: center;
            padding: 1rem;
            background: var(--accent-color, #e0eaff);
            border-radius: 8px;
            color: var(--primary-color, #0055b3);
        }

        body.dark-theme .stat {
            background: var(--dark-accent, #1a1a2e);
            color: var(--dark-primary, #4A90E2);
        }

        .stat i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .stat span {
            display: block;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .stat p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-light, #6b7280);
        }

        .user-contributions-list {
            margin-top: 1.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .user-link {
            cursor: pointer;
            color: inherit;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .user-link:hover {
            color: var(--primary-color, #0055b3);
            text-decoration: underline;
        }

        body.dark-theme .user-link:hover {
            color: var(--dark-primary, #4A90E2);
        }

        body.dark-theme .user-link:hover {
            color: var(--dark-primary-hover, #5AA0F2);
        }

        .location-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .delete-location-btn {
            background: none;
            border: none;
            color: var(--danger-color, #dc3545);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .delete-location-btn:hover {
            background-color: rgba(220, 53, 69, 0.1);
        }

        body.dark-theme .delete-location-btn {
            color: var(--dark-danger, #ff4d4d);
        }

        body.dark-theme .delete-location-btn:hover {
            background-color: rgba(255, 77, 77, 0.1);
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }

        .alert.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        body.dark-theme .alert.success {
            background-color: #1e4a2e;
            color: #9be6b1;
            border-color: #2d5a3d;
        }

        body.dark-theme .alert.error {
            background-color: #4a1e1e;
            color: #e6a5a5;
            border-color: #5a2d2d;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Profile Modal Styles */
        .profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .profile-modal.active {
            display: flex;
        }

        .profile-modal-content {
            background-color: var(--background-color, #fff);
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        body.dark-theme .profile-modal-content {
            background-color: var(--dark-card, #1e1e2d);
        }

        .profile-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color, #1f2937);
            padding: 0.5rem;
            line-height: 1;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .profile-modal-close:hover {
            background-color: var(--accent-color, #e0eaff);
        }

        body.dark-theme .profile-modal-close {
            color: var(--dark-text, #e2e8f0);
        }

        body.dark-theme .profile-modal-close:hover {
            background-color: var(--dark-accent, #1E293B);
        }

        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .profile-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-right: 1rem;
            background-size: cover;
            background-position: center;
            background-color: var(--primary-color, #0055b3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: 600;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0 0 0.5rem 0;
            color: var(--text-color, #1f2937);
        }

        body.dark-theme .profile-name {
            color: var(--dark-text, #e2e8f0);
        }

        .profile-email {
            color: var(--text-light, #6b7280);
            margin: 0;
            font-size: 0.9rem;
        }

        body.dark-theme .profile-email {
            color: var(--dark-text-light, #94a3b8);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color, #d1d5db);
        }

        body.dark-theme .profile-stats {
            border-color: var(--dark-border, #2d3748);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color, #0055b3);
            margin: 0;
        }

        body.dark-theme .stat-value {
            color: var(--dark-primary, #4A90E2);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-light, #6b7280);
            margin: 0.25rem 0 0 0;
        }

        body.dark-theme .stat-label {
            color: var(--dark-text-light, #94a3b8);
        }

        .profile-roles {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .role-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            color: white;
        }

        .admin-badge {
            background-color: #4CAF50;
        }

        .user-badge {
            background-color: #2196F3;
        }

        body.dark-theme .admin-badge {
            background-color: #2E7D32;
        }

        body.dark-theme .user-badge {
            background-color: #1565C0;
        }
    </style>
</head>
<body>
    <!-- Navigation (Adaptado do Site Base) -->
    <nav class="navbar" id="main-nav">
        <div class="container">
            <div class="navbar-content">
                <!-- Logo com nome -->
                <a href="../index.html" class="logo">
                    <img src="../public/images/logo.png" alt="WACS Logo" class="logo-dark">
                    <img src="../public/images/logo-light.png" alt="WACS Logo" class="logo-light">
                    <span class="logo-text">WACS</span>
                </a>

                <!-- Desktop Menu -->
                <div class="nav-menu">
                    <ul class="nav-links">
                        <li><a href="../index.html">Home</a></li>
                        <li><a href="dashboard.html" class="active">Dashboard</a></li>
                        <li><a href="profile.html">Perfil</a></li>
                    </ul>
                </div>

                <!-- Actions -->
                <div class="nav-actions">
                    <div class="theme-toggle">
                        <label class="switch">
                            <span class="sun"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g fill="#ffd43b"><circle r="5" cy="12" cx="12"></circle><path d="m21 13h-1a1 1 0 0 1 0-2h1a1 1 0 0 1 0 2zm-17 0h-1a1 1 0 0 1 0-2h1a1 1 0 0 1 0 2zm13.66-5.66a1 1 0 0 1 -.66-.29 1 1 0 0 1 0-1.41l.71-.71a1 1 0 1 1 1.41 1.41l-.71.71a1 1 0 0 1 -.75.29zm-12.02 12.02a1 1 0 0 1 -.71-.29 1 1 0 0 1 0-1.41l.71-.66a1 1 0 0 1 1.41 1.41l-.71.71a1 1 0 0 1 -.7.24zm6.36-14.36a1 1 0 0 1 -1-1v-1a1 1 0 0 1 2 0v1a1 1 0 0 1 -1 1zm0 17a1 1 0 0 1 -1-1v-1a1 1 0 0 1 2 0v1a1 1 0 0 1 -1 1zm-5.66-14.66a1 1 0 0 1 -.7-.29l-.71-.71a1 1 0 0 1 1.41-1.41l.71.71a1 1 0 0 1 0 1.41 1 1 0 0 1 -.71.29zm12.02 12.02a1 1 0 0 1 -.7-.29l-.66-.71a1 1 0 0 1 1.36-1.36l.71.71a1 1 0 0 1 0 1.41 1 1 0 0 1 -.71.24z"></path></g></svg></span>
                            <span class="moon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="m223.5 32c-123.5 0-223.5 100.3-223.5 224s100 224 223.5 224c60.6 0 115.5-24.2 155.8-63.4 5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6-96.9 0-175.5-78.8-175.5-176 0-65.8 36-123.1 89.3-153.3 6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z"></path></svg></span>   
                            <input type="checkbox" class="input" id="theme-switch" aria-label="Toggle theme">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <button id="logoutBtn" class="logout-btn">Sair</button>
                </div>

                <!-- Mobile Menu Button -->
                <button class="menu-toggle" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>

            <!-- Mobile Menu Panel -->
            <div class="mobile-menu">
                <ul class="nav-links-mobile">
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="dashboard.html" class="active">Dashboard</a></li>
                    <li><a href="profile.html">Perfil</a></li>
                </ul>
                <button id="logoutBtnMobile" class="download-btn-mobile">Sair</button>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="container">
                <div class="user-info">
                    <a href="profile.html" class="user-avatar" id="userAvatar" title="Editar perfil">
                        <i class="fas fa-user"></i>
                    </a>
                    <div class="user-details">
                        <h2 id="userName">Carregando...</h2>
                        <p id="userEmail">Carregando...</p>
                        <a href="profile.html" class="profile-link">
                            <i class="fas fa-edit"></i> Editar perfil
                        </a>
                    </div>
                </div>
                
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="stat-content">
                            <h3>Locais Acessíveis</h3>
                            <p></p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <h3>Colaboradores</h3>
                            <p></p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-content">
                            <h3>Suas Contribuições</h3>
                            <p></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="dashboard-content">
            <div class="container">
                <div class="dashboard-section">
                    <h2>Mapa de Locais Acessíveis</h2>
                    <div class="map-container">
                        <p>O mapa será carregado aqui</p>
                    </div>
                </div>
                
                <div class="dashboard-section">
                    <h2>Locais Recentes</h2>
                    <div class="locations-list">
                        <div class="location-card">
                            <div class="location-image">
                                <i class="fas fa-image"></i> Imagem do Local
                            </div>
                            <div class="location-details">
                                <h3>Shopping Center Registro</h3>
                                <p>Av. Clara Gianotti de Souza, 1500 - Registro, SP</p>
                                <p>Rampa de acesso, elevadores, banheiros adaptados</p>
                                <div class="location-rating">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star-half-alt"></i>
                                    <span>4.5 (15 avaliações)</span>
                                </div>
                            </div>
                        </div>
                        <div class="location-card">
                            <div class="location-image">
                                <i class="fas fa-image"></i> Imagem do Local
                            </div>
                            <div class="location-details">
                                <h3>Parque Municipal</h3>
                                <p>Rua dos Expedicionários, 340 - Registro, SP</p>
                                <p>Caminhos acessíveis, área de descanso, banheiros adaptados</p>
                                <div class="location-rating">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="far fa-star"></i>
                                    <span>4.0 (8 avaliações)</span>
                                </div>
                            </div>
                        </div>
                        <div class="location-card">
                            <div class="location-image">
                                <i class="fas fa-image"></i> Imagem do Local
                            </div>
                            <div class="location-details">
                                <h3>Terminal Rodoviário</h3>
                                <p>Av. Prefeito Jonas Banks Leite, 300 - Registro, SP</p>
                                <p>Elevadores, piso tátil, rampas de acesso</p>
                                <div class="location-rating">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="far fa-star"></i>
                                    <i class="far fa-star"></i>
                                    <span>3.2 (10 avaliações)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <a href="#" class="add-location-btn" id="openAddLocationModal">
                        <i class="fas fa-plus"></i> Adicionar Local Acessível
                    </a>
                </div>
                
                <!-- Nova seção de Chat -->
                <div class="dashboard-section">
                    <h2>Chat Comunitário</h2>
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div class="chat-loading">
                                <i class="fas fa-spinner fa-pulse"></i> Carregando mensagens...
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <input type="file" id="chatImageInput" accept="image/*" style="display:none;">
                            <button type="button" id="chatImageBtn" title="Enviar imagem" style="background:none;border:none;padding:0 10px;cursor:pointer;height: 38px; vertical-align: middle; margin-right: 5px; color: var(--text-color);">
                                <i class="fas fa-paperclip" style="font-size: 18px;"></i>
                            </button>
                            <textarea id="chatMessageInput" placeholder="Digite sua mensagem aqui..." rows="2"></textarea>
                            <button id="sendMessageBtn" class="chat-send-btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para adicionar local acessível -->
    <div id="addLocationModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Adicionar Local Acessível</h2>
            <form id="addLocationForm">
                <div class="form-group">
                    <label for="locationName">Nome do Local</label>
                    <input type="text" id="locationName" required>
                </div>
                <div class="form-group">
                    <label for="locationAddress">Endereço Completo</label>
                    <input type="text" id="locationAddress" required>
                </div>
                <div class="form-group">
                    <label for="locationMap">Selecione o Local no Mapa</label>
                    <div id="locationMap" class="location-map-selector"></div>
                    <p class="map-instructions">Clique no mapa para selecionar a localização exata ou busque pelo endereço acima</p>
                    <div class="coordinates-fields">
                        <div class="coordinate-field">
                            <label for="locationLat">Latitude</label>
                            <input type="text" id="locationLat" readonly>
                        </div>
                        <div class="coordinate-field">
                            <label for="locationLng">Longitude</label>
                            <input type="text" id="locationLng" readonly>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Recursos de Acessibilidade</label>
                    <div class="accessibility-options">
                        <label class="accessibility-option">
                            <input type="checkbox" name="accessibility" value="wheelchair" class="accessibility-checkbox">
                            <div class="option-content">
                                <i class="fas fa-wheelchair"></i>
                                <span>Cadeira de Rodas</span>
                            </div>
                        </label>
                        <label class="accessibility-option">
                            <input type="checkbox" name="accessibility" value="blind" class="accessibility-checkbox">
                            <div class="option-content">
                                <i class="fas fa-walking"></i>
                                <span>Piso Tátil</span>
                            </div>
                        </label>
                        <label class="accessibility-option">
                            <input type="checkbox" name="accessibility" value="deaf" class="accessibility-checkbox">
                            <div class="option-content">
                                <i class="fas fa-arrow-up-right-from-square"></i>
                                <span>Rampa</span>
                            </div>
                        </label>
                        <label class="accessibility-option">
                            <input type="checkbox" name="accessibility" value="elevator" class="accessibility-checkbox">
                            <div class="option-content">
                                <i class="fas fa-elevator"></i>
                                <span>Elevador</span>
                            </div>
                        </label>
                        <label class="accessibility-option">
                            <input type="checkbox" name="accessibility" value="parking" class="accessibility-checkbox">
                            <div class="option-content">
                                <i class="fas fa-restroom"></i>
                                <span>Banheiro Adaptado</span>
                            </div>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="locationImage">Imagem do Local</label>
                    <input type="file" id="locationImage" accept="image/*" required>
                    <small class="form-text">Selecione uma imagem do local (máximo 5MB)</small>
                </div>
                <button type="submit" class="submit-btn">Salvar Local</button>
            </form>
        </div>
    </div>
    
    <!-- Modal para avaliação de local -->
    <div id="rateLocationModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Avaliar Local</h2>
            <div id="locationToRate"></div>
            <form id="rateLocationForm">
                <input type="hidden" id="locationIdToRate">
                <div class="form-group">
                    <label>Avaliação dos Recursos de Acessibilidade</label>
                    <div id="accessibilityRatings" class="accessibility-ratings">
                        <!-- Será preenchido dinamicamente -->
                    </div>
                </div>
                <div class="form-group">
                    <label for="ratingComment">Comentário (opcional)</label>
                    <textarea id="ratingComment" rows="3"></textarea>
                </div>
                <button type="submit" class="submit-btn">Enviar Avaliação</button>
            </form>
        </div>
    </div>

    <!-- Modal para todos os comentários -->
    <div id="allReviewsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Avaliações do Local</h2>
            <div id="locationReviewsInfo"></div>
            <div id="allReviewsList" class="all-reviews-list">
                <p>Carregando avaliações...</p>
            </div>
        </div>
    </div>

    <!-- Modal de Perfil do Usuário -->
    <div id="userProfileModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div class="user-profile-header">
                <div class="user-profile-photo">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-profile-info">
                    <h2 id="modalUserName">Nome do Usuário</h2>
                    <p id="modalUserEmail">email@exemplo.com</p>
                </div>
            </div>
            <div class="user-profile-actions">
                <button class="action-btn chat-btn">
                    <i class="fas fa-comment"></i> Conversar
                </button>
                <button class="action-btn friend-btn">
                    <i class="fas fa-user-plus"></i> Adicionar Amigo
                </button>
            </div>
            <div class="user-profile-contributions">
                <h3>Contribuições</h3>
                <div class="contribution-stats">
                    <div class="stat">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="modalUserLocations">0</span>
                        <p>Locais Adicionados</p>
                    </div>
                    <div class="stat">
                        <i class="fas fa-star"></i>
                        <span id="modalUserReviews">0</span>
                        <p>Avaliações</p>
                    </div>
                </div>
                <div id="modalUserContributions" class="user-contributions-list">
                    <!-- Lista de contribuições será preenchida dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Profile Modal HTML -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-modal-content">
            <button class="profile-modal-close" id="profileModalClose">&times;</button>
            <div class="profile-header">
                <div class="profile-photo" id="profilePhoto"></div>
                <div class="profile-info">
                    <h2 class="profile-name" id="profileName"></h2>
                    <div class="profile-roles" id="profileRoles"></div>
                    <p class="profile-email" id="profileEmail"></p>
                </div>
            </div>
            <div class="profile-stats">
                <div class="stat-item">
                    <p class="stat-value" id="profileMessages">0</p>
                    <p class="stat-label">Mensagens</p>
                </div>
                <div class="stat-item">
                    <p class="stat-value" id="profileContributions">0</p>
                    <p class="stat-label">Contribuições</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <script src="../public/js/theme.js"></script>
    <script src="../public/js/navbar-modern.js"></script>
    <script src="../public/js/env-config.js"></script>
    <script src="../public/js/firebase-dashboard.js"></script>
    
    <!-- Script para o modal e funcionalidade de adicionar locais -->
    <script>
        // Função global para renderizar estrelas de avaliação
        function renderRatingStars(rating, size = 'normal') {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            
            let starsHTML = '';
            
            // Classes diferentes baseadas no tamanho
            let starClass = size === 'small' ? 'fa-xs' : '';
            
            // Estrelas cheias
            for (let i = 0; i < fullStars; i++) {
                starsHTML += `<i class="fas fa-star ${starClass}"></i>`;
            }
            
            // Meia estrela (se aplicável)
            if (hasHalfStar) {
                starsHTML += `<i class="fas fa-star-half-alt ${starClass}"></i>`;
            }
            
            // Estrelas vazias
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += `<i class="far fa-star ${starClass}"></i>`;
            }
            
            return starsHTML;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Elementos do DOM
            const openModalBtn = document.getElementById('openAddLocationModal');
            const modal = document.getElementById('addLocationModal');
            const closeModalBtn = document.querySelector('.close-modal');
            const form = document.getElementById('addLocationForm');
            const locationsContainer = document.querySelector('.locations-list');
            
            // Elementos do modal de avaliação
            const rateModal = document.getElementById('rateLocationModal');
            const rateForm = document.getElementById('rateLocationForm');
            const closeRateModalBtn = rateModal.querySelector('.close-modal');
            const ratingStars = document.querySelectorAll('.rating-stars i');
            const ratingValueInput = document.getElementById('ratingValue');
            
            // Variáveis para o mapa
            let map, marker, geocoder, placesService;
            let defaultLocation = { lat: -24.4874, lng: -47.8446 }; // Registro, SP como localização padrão
            
            // Configuração das estrelas de avaliação
            ratingStars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = this.getAttribute('data-rating');
                    ratingValueInput.value = rating;
                    
                    // Atualizar visual das estrelas
                    ratingStars.forEach(s => {
                        const sRating = s.getAttribute('data-rating');
                        if (sRating <= rating) {
                            s.classList.remove('far');
                            s.classList.add('fas');
                        } else {
                            s.classList.remove('fas');
                            s.classList.add('far');
                        }
                    });
                });
            });
            
            // Inicializar o mapa quando o modal for aberto
            function initLocationMap() {
                if (!map && google && google.maps) {
                    const mapOptions = {
                        center: defaultLocation,
                        zoom: 15,
                        mapTypeId: google.maps.MapTypeId.ROADMAP,
                        mapTypeControl: false,
                        streetViewControl: false,
                        fullscreenControl: false
                    };
                    
                    map = new google.maps.Map(document.getElementById('locationMap'), mapOptions);
                    geocoder = new google.maps.Geocoder();
                    placesService = new google.maps.places.PlacesService(map);
                    
                    // Adicionar marcador inicial
                    marker = new google.maps.Marker({
                        position: defaultLocation,
                        map: map,
                        draggable: true,
                        animation: google.maps.Animation.DROP,
                    });
                    
                    // Atualizar campos quando o marcador for movido
                    marker.addListener('dragend', function() {
                        const position = marker.getPosition();
                        updateCoordinateFields(position.lat(), position.lng());
                        geocodePosition(position);
                    });
                    
                    // Permitir que o usuário clique no mapa para mover o marcador
                    map.addListener('click', function(event) {
                        marker.setPosition(event.latLng);
                        updateCoordinateFields(event.latLng.lat(), event.latLng.lng());
                        geocodePosition(event.latLng);
                    });
                    
                    // Preencher os campos iniciais de coordenadas
                    updateCoordinateFields(defaultLocation.lat, defaultLocation.lng);
                    
                    // Configurar a busca por endereço
                    const addressInput = document.getElementById('locationAddress');
                    addressInput.addEventListener('blur', function() {
                        if (addressInput.value.trim() !== '') {
                            geocodeAddress(addressInput.value);
                        }
                    });
                    
                    // Adicionar botão Enter para buscar o endereço
                    addressInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault(); // Prevenir o envio do formulário
                            if (addressInput.value.trim() !== '') {
                                geocodeAddress(addressInput.value);
                            }
                        }
                    });
                }
            }
            
            // Função para geocodificar um endereço e atualizar o mapa
            function geocodeAddress(address) {
                if (geocoder) {
                    geocoder.geocode({ 'address': address }, function(results, status) {
                        if (status === google.maps.GeocoderStatus.OK) {
                            const location = results[0].geometry.location;
                            
                            map.setCenter(location);
                            marker.setPosition(location);
                            updateCoordinateFields(location.lat(), location.lng());
                            
                            // Zoom mais próximo para endereços específicos
                            map.setZoom(17);
                        } else {
                            console.error('Geocode falhou: ' + status);
                            alert('Não foi possível encontrar este endereço. Por favor, tente outro ou selecione manualmente no mapa.');
                        }
                    });
                }
            }
            
            // Função para geocodificar uma posição e atualizar o campo de endereço
            function geocodePosition(latLng) {
                if (geocoder) {
                    geocoder.geocode({ 'location': latLng }, function(results, status) {
                        if (status === google.maps.GeocoderStatus.OK && results[0]) {
                            document.getElementById('locationAddress').value = results[0].formatted_address;
                        } else {
                            console.error('Geocode reverso falhou: ' + status);
                        }
                    });
                }
            }
            
            // Atualizar os campos de coordenadas
            function updateCoordinateFields(lat, lng) {
                document.getElementById('locationLat').value = lat.toFixed(6);
                document.getElementById('locationLng').value = lng.toFixed(6);
            }
            
            // Abrir modal
            openModalBtn.addEventListener('click', function(e) {
                e.preventDefault();
                modal.style.display = 'block';
                
                // Inicializar mapa após um pequeno atraso para garantir que o DOM esteja pronto
                setTimeout(function() {
                    initLocationMap();
                    
                    // Redimensionar o mapa para garantir que seja exibido corretamente
                    if (map) {
                        google.maps.event.trigger(map, 'resize');
                        map.setCenter(marker.getPosition());
                    }
                }, 300);
            });
            
            // Fechar modal (X)
            closeModalBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });

            // Fechar modal de avaliação (X)
            closeRateModalBtn.addEventListener('click', function() {
                rateModal.style.display = 'none';
            });
            
            // Fechar modal ao clicar fora do conteúdo
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
                if (event.target === rateModal) {
                    rateModal.style.display = 'none';
                }
            });
            
            // Renderizar estrelas de avaliação baseado na pontuação
            function renderRatingStars(rating, size = 'normal') {
                const fullStars = Math.floor(rating);
                const hasHalfStar = rating % 1 >= 0.5;
                const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                
                let starsHTML = '';
                
                // Estrelas cheias
                for (let i = 0; i < fullStars; i++) {
                    starsHTML += '<i class="fas fa-star"></i>';
                }
                
                // Meia estrela (se aplicável)
                if (hasHalfStar) {
                    starsHTML += '<i class="fas fa-star-half-alt"></i>';
                }
                
                // Estrelas vazias
                for (let i = 0; i < emptyStars; i++) {
                    starsHTML += '<i class="far fa-star"></i>';
                }
                
                return starsHTML;
            }
            
            // Função para formatar texto de avaliação (plural/singular)
            function formatReviewText(count) {
                if (count === 0) return "Sem avaliações";
                if (count === 1) return "1 avaliação";
                return `${count} avaliações`;
            }
            
            // Função para carregar avaliações de um local específico
            function loadLocationReviews(locationId, container) {
                firebase.firestore().collection('reviews')
                    .where('locationId', '==', locationId)
                    .orderBy('createdAt', 'desc')
                    .limit(3)
                    .get()
                    .then((querySnapshot) => {
                        if (querySnapshot.empty) {
                            container.innerHTML = '<p>Nenhuma avaliação ainda. Seja o primeiro a avaliar!</p>';
                            return;
                        }
                        
                        let reviewsHTML = '';
                        
                        querySnapshot.forEach((doc) => {
                            const review = doc.data();
                            const date = review.createdAt ? new Date(review.createdAt.toDate()) : new Date();
                            const formattedDate = date.toLocaleDateString('pt-BR');
                            
                            reviewsHTML += `
                                <div class="review-item">
                                    <div class="review-header">
                                        <span class="review-author">${review.userName}</span>
                                        <span class="review-date">${formattedDate}</span>
                                    </div>
                                    <div class="review-stars">
                                        ${renderRatingStars(review.rating)}
                                    </div>
                                    ${review.comment ? `<p class="review-text">${review.comment}</p>` : ''}
                                </div>
                            `;
                        });
                        
                        container.innerHTML = reviewsHTML;
                    })
                    .catch((error) => {
                        console.error('Erro ao carregar avaliações:', error);
                        container.innerHTML = '<p>Erro ao carregar avaliações. Por favor, tente novamente.</p>';
                    });
            }
            
            // Função para abrir o modal de avaliação
            function openRateModal(locationId, locationName, locationAddress) {
                // Limpar formulário anterior
                rateForm.reset();
                ratingStars.forEach(s => {
                    s.classList.remove('fas');
                    s.classList.add('far');
                });
                
                // Preencher informações do local a ser avaliado
                document.getElementById('locationIdToRate').value = locationId;
                document.getElementById('locationToRate').innerHTML = `
                    <h3>${locationName}</h3>
                    <p>${locationAddress}</p>
                `;

                // Buscar informações do local para obter os recursos de acessibilidade
                firebase.firestore().collection('accessibleLocations').doc(locationId).get()
                    .then((doc) => {
                        if (doc.exists) {
                            const location = doc.data();
                            const accessibilityFeatures = location.accessibilityFeatures || [];
                            
                            // Mapear recursos para ícones e nomes
                            const featureMap = {
                                'wheelchair': { icon: 'fa-wheelchair', name: 'Cadeira de Rodas' },
                                'blind': { icon: 'fa-walking', name: 'Piso Tátil' },
                                'deaf': { icon: 'fa-arrow-up-right-from-square', name: 'Rampa' },
                                'elevator': { icon: 'fa-elevator', name: 'Elevador' },
                                'parking': { icon: 'fa-restroom', name: 'Banheiro Adaptado' }
                            };

                            // Criar HTML para cada recurso
                            const ratingsHTML = accessibilityFeatures.map(feature => {
                                const featureInfo = featureMap[feature];
                                if (!featureInfo) return '';

                                return `
                                    <div class="accessibility-rating-item">
                                        <i class="fas ${featureInfo.icon} feature-icon"></i>
                                        <span class="feature-name">${featureInfo.name}</span>
                                        <div class="feature-stars" data-feature="${feature}">
                                            <i class="far fa-star" data-rating="1"></i>
                                            <i class="far fa-star" data-rating="2"></i>
                                            <i class="far fa-star" data-rating="3"></i>
                                            <i class="far fa-star" data-rating="4"></i>
                                            <i class="far fa-star" data-rating="5"></i>
                                            <input type="hidden" name="feature_rating_${feature}" value="">
                                        </div>
                                    </div>
                                `;
                            }).join('');

                            // Atualizar o container de avaliações
                            const accessibilityRatingsContainer = document.getElementById('accessibilityRatings');
                            if (accessibilityRatingsContainer) {
                                accessibilityRatingsContainer.innerHTML = ratingsHTML;

                                // Adicionar eventos para as estrelas de cada recurso
                                document.querySelectorAll('.feature-stars').forEach(starsContainer => {
                                    const stars = starsContainer.querySelectorAll('i');
                                    const input = starsContainer.querySelector('input');
                                    
                                    stars.forEach(star => {
                                        star.addEventListener('click', function() {
                                            const rating = this.getAttribute('data-rating');
                                            input.value = rating;
                                            
                                            // Atualizar visual das estrelas
                                            stars.forEach(s => {
                                                const sRating = s.getAttribute('data-rating');
                                                if (sRating <= rating) {
                                                    s.classList.remove('far');
                                                    s.classList.add('fas');
                                                } else {
                                                    s.classList.remove('fas');
                                                    s.classList.add('far');
                                                }
                                            });
                                        });
                                    });
                                });
                            }
                        }
                    })
                    .catch((error) => {
                        console.error('Erro ao carregar informações do local:', error);
                    });
                
                // Abrir modal
                rateModal.style.display = 'block';
            }
            
            // Adicionar evento de submit para o formulário de avaliação
            rateForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Verificar se o usuário está autenticado
                const user = firebase.auth().currentUser;
                if (!user) {
                    alert('Você precisa estar logado para avaliar um local.');
                    return;
                }
                
                // Obter valores do formulário
                const locationId = document.getElementById('locationIdToRate').value;
                const comment = document.getElementById('ratingComment').value;
                
                // Coletar avaliações dos recursos de acessibilidade
                const featureRatings = {};
                document.querySelectorAll('.feature-stars').forEach(starsContainer => {
                    const feature = starsContainer.getAttribute('data-feature');
                    const rating = parseInt(starsContainer.querySelector('input').value);
                    if (rating) {
                        featureRatings[feature] = rating;
                    }
                });

                // Validar se todas as opções de acessibilidade foram avaliadas
                const location = await firebase.firestore().collection('accessibleLocations').doc(locationId).get();
                const accessibilityFeatures = location.data().accessibilityFeatures || [];
                const missingRatings = accessibilityFeatures.filter(feature => !featureRatings[feature]);

                if (missingRatings.length > 0) {
                    alert('Por favor, avalie todos os recursos de acessibilidade disponíveis.');
                    return;
                }

                // Calcular a média das avaliações de acessibilidade
                const ratings = Object.values(featureRatings);
                const averageRating = ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length;
                
                // Preparar objeto de avaliação
                const reviewData = {
                    locationId: locationId,
                    userId: user.uid,
                    userName: user.displayName || user.email.split('@')[0],
                    rating: parseFloat(averageRating.toFixed(1)), // Média arredondada para 1 casa decimal
                    featureRatings: featureRatings,
                    comment: comment,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Salvar avaliação no Firestore
                firebase.firestore().collection('reviews').add(reviewData)
                    .then(() => {
                        // Atualizar a média de avaliações do local
                        updateLocationRating(locationId);
                        
                        // Fechar modal e mostrar confirmação
                        rateModal.style.display = 'none';
                        alert('Avaliação enviada com sucesso!');
                    })
                    .catch((error) => {
                        console.error('Erro ao adicionar avaliação:', error);
                        alert('Ocorreu um erro ao enviar sua avaliação. Por favor, tente novamente.');
                    });
            });
            
            // Função para atualizar a média de avaliações de um local
            function updateLocationRating(locationId) {
                firebase.firestore().collection('reviews')
                    .where('locationId', '==', locationId)
                    .get()
                    .then((querySnapshot) => {
                        // Calcular média das avaliações
                        let totalRating = 0;
                        let reviewCount = querySnapshot.size;
                        
                        querySnapshot.forEach((doc) => {
                            totalRating += doc.data().rating;
                        });
                        
                        const averageRating = reviewCount > 0 ? totalRating / reviewCount : 0;
                        
                        // Atualizar o documento do local
                        firebase.firestore().collection('accessibleLocations').doc(locationId).update({
                            rating: parseFloat(averageRating.toFixed(1)),
                            reviewCount: reviewCount
                        })
                        .then(() => {
                            // Atualizar a UI, recarregando os locais
                            loadLocations();
                        })
                        .catch((error) => {
                            console.error('Erro ao atualizar avaliação do local:', error);
                        });
                    })
                    .catch((error) => {
                        console.error('Erro ao carregar avaliações:', error);
                    });
            }
            
            // Adicionar local ao enviar o formulário
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Verificar se o usuário está autenticado
                const user = firebase.auth().currentUser;
                if (!user) {
                    alert('Você precisa estar logado para adicionar um local.');
                    return;
                }
                
                // Obter valores do formulário
                const name = document.getElementById('locationName').value;
                const address = document.getElementById('locationAddress').value;
                const imageFile = document.getElementById('locationImage').files[0];
                const lat = parseFloat(document.getElementById('locationLat').value);
                const lng = parseFloat(document.getElementById('locationLng').value);
                
                // Validar tamanho da imagem (máximo 5MB)
                if (imageFile.size > 5 * 1024 * 1024) {
                    alert('A imagem deve ter no máximo 5MB.');
                    return;
                }
                
                // Coletar opções de acessibilidade selecionadas
                const accessibilityOptions = Array.from(document.querySelectorAll('.accessibility-checkbox:checked'))
                    .map(checkbox => checkbox.value);
                
                // Validar se pelo menos uma opção de acessibilidade foi selecionada
                if (accessibilityOptions.length === 0) {
                    alert('Por favor, selecione pelo menos uma opção de acessibilidade.');
                    return;
                }
                
                // Validar coordenadas
                if (isNaN(lat) || isNaN(lng)) {
                    alert('Por favor, selecione um local válido no mapa.');
                    return;
                }

                try {
                    // Mostrar indicador de carregamento
                    const submitBtn = form.querySelector('.submit-btn');
                    const originalBtnText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
                    submitBtn.disabled = true;

                    // Upload da imagem para o Firebase Storage
                    const storageRef = firebase.storage().ref();
                    const fileName = `${user.uid}_${Date.now()}_${imageFile.name}`;
                    const imageRef = storageRef.child(`locations/${fileName}`);
                    await imageRef.put(imageFile);
                    const imageUrl = await imageRef.getDownloadURL();
                    
                    // Preparar objeto para o Firestore
                    const locationData = {
                        name: name,
                        address: address,
                        accessibilityFeatures: accessibilityOptions,
                        imageUrl: imageUrl,
                        location: new firebase.firestore.GeoPoint(lat, lng),
                        userId: user.uid,
                        userName: user.displayName || user.email.split('@')[0],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        rating: 0,
                        reviewCount: 0
                    };
                    
                    // Usar o nome do local como ID do documento
                    const docId = name.trim();
                    
                    // Salvar no Firestore usando o nome como ID
                    await firebase.firestore().collection('accessibleLocations').doc(docId).set(locationData);
                    
                    // Adicionar o ID do documento aos dados
                    locationData.id = docId;
                    
                    // Atualizar a UI
                    addLocationToUI(locationData);
                    
                    // Resetar o formulário e fechar o modal
                    form.reset();
                    modal.style.display = 'none';
                    
                    // Mostrar mensagem de sucesso
                    alert('Local adicionado com sucesso!');
                    
                    // Atualizar contador de contribuições do usuário
                    updateUserContributionCount();
                    
                    // Atualizar o mapa principal (se disponível)
                    if (typeof updateMainMap === 'function') {
                        updateMainMap();
                    }
                } catch (error) {
                    console.error('Erro ao adicionar local:', error);
                    alert('Ocorreu um erro ao adicionar o local. Por favor, tente novamente.');
                } finally {
                    // Restaurar botão de envio
                    const submitBtn = form.querySelector('.submit-btn');
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                }
            });
            
            // Função para adicionar um novo local à interface
            function addLocationToUI(location) {
                const locationCard = document.createElement('div');
                locationCard.className = 'location-card';
                locationCard.dataset.id = location.id;
                
                // Calcular ou usar a avaliação existente
                const rating = location.rating || 0;
                const reviewCount = location.reviewCount || 0;
                
                locationCard.innerHTML = `
                    <div class="location-image">
                        ${location.imageUrl.includes('placeholder') 
                            ? '<i class="fas fa-image"></i> Imagem do Local' 
                            : `<img src="${location.imageUrl}" alt="${location.name}">`}
                    </div>
                    <div class="location-details">
                        <h3>${location.name}</h3>
                        <p>${location.address}</p>
                        <div class="accessibility-features">
                            ${(location.accessibilityFeatures || []).map(feature => {
                                const icons = {
                                    'wheelchair': '<i class="fas fa-wheelchair" title="Cadeira de Rodas"></i>',
                                    'blind': '<i class="fas fa-walking" title="Piso Tátil"></i>',
                                    'deaf': '<i class="fas fa-arrow-up-right-from-square" title="Rampa"></i>',
                                    'elevator': '<i class="fas fa-elevator" title="Elevador"></i>',
                                    'parking': '<i class="fas fa-restroom" title="Banheiro Adaptado"></i>'
                                };
                                return icons[feature] || '';
                            }).join(' ')}
                        </div>
                        <div class="location-rating">
                            ${renderRatingStars(rating)}
                            <span>${rating.toFixed(1)} (${formatReviewText(reviewCount)})</span>
                        </div>
                        <button class="rate-button" data-id="${location.id}" data-name="${location.name}" data-address="${location.address}">
                            <i class="fas fa-star"></i> Avaliar Local
                        </button>
                        <div class="last-review" id="last-review-${location.id}">
                            <p>Carregando última avaliação...</p>
                        </div>
                        ${reviewCount > 0 ? `
                            <button class="view-all-reviews-btn" data-id="${location.id}" data-name="${location.name}">
                                Ver todas as avaliações <i class="fas fa-chevron-right"></i>
                            </button>
                        ` : ''}
                    </div>
                `;
                
                // Adicionar no início da lista
                if (locationsContainer.firstChild) {
                    locationsContainer.insertBefore(locationCard, locationsContainer.firstChild);
                } else {
                    locationsContainer.appendChild(locationCard);
                }
                
                // Adicionar evento ao botão de avaliação
                const rateButton = locationCard.querySelector('.rate-button');
                if (rateButton) {
                    rateButton.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        const name = this.getAttribute('data-name');
                        const address = this.getAttribute('data-address');
                        openRateModal(id, name, address);
                    });
                }
                
                // Adicionar evento ao botão de ver todas as avaliações
                const viewAllReviewsBtn = locationCard.querySelector('.view-all-reviews-btn');
                if (viewAllReviewsBtn) {
                    viewAllReviewsBtn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        const name = this.getAttribute('data-name');
                        openAllReviewsModal(id, name);
                    });
                }
                
                // Carregar a última avaliação
                loadLastReview(location.id);
            }
            
            // Função para carregar a última avaliação de um local
            function loadLastReview(locationId) {
                const lastReviewContainer = document.getElementById(`last-review-${locationId}`);
                
                firebase.firestore().collection('reviews')
                    .where('locationId', '==', locationId)
                    .get()
                    .then((querySnapshot) => {
                        if (querySnapshot.empty) {
                            lastReviewContainer.innerHTML = '<p class="no-reviews">Nenhuma avaliação ainda. Seja o primeiro a avaliar!</p>';
                            return;
                        }
                        
                        // Ordenar as avaliações em memória
                        const reviews = querySnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        
                        // Ordenar por data de criação (mais recente primeiro)
                        reviews.sort((a, b) => {
                            const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                            const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                            return dateB - dateA;
                        });
                        
                        const review = reviews[0]; // Pegar a mais recente
                        const date = review.createdAt ? new Date(review.createdAt.toDate()) : new Date();
                        const formattedDate = date.toLocaleDateString('pt-BR');

                        lastReviewContainer.innerHTML = `
                            <div class="last-review-content">
                                <div class="review-header">
                                    <span class="review-author">${review.userName}</span>
                                    <span class="review-date">${formattedDate}</span>
                                </div>
                                <div class="review-stars">
                                    ${renderRatingStars(review.rating)}
                                </div>
                                ${review.comment ? `<p class="review-text">${review.comment}</p>` : ''}
                            </div>
                        `;
                    })
                    .catch((error) => {
                        console.error('Erro ao carregar última avaliação:', error);
                        lastReviewContainer.innerHTML = '<p class="review-error">Erro ao carregar avaliação</p>';
                    });
            }
            
            // Função para carregar locais do Firestore
            function loadLocations() {
                firebase.firestore().collection('accessibleLocations')
                    .orderBy('createdAt', 'desc')
                    .limit(6)
                    .get()
                    .then((querySnapshot) => {
                        // Limpar o container de locais
                        locationsContainer.innerHTML = '';
                        
                        // Verificar se há locais
                        if (querySnapshot.empty) {
                            locationsContainer.innerHTML = '<p class="no-locations">Nenhum local acessível cadastrado ainda. Seja o primeiro a contribuir!</p>';
                            return;
                        }
                        
                        // Adicionar cada local à UI
                        querySnapshot.forEach((doc) => {
                            const locationData = doc.data();
                            locationData.id = doc.id;
                            addLocationToUI(locationData);
                        });
                    })
                    .catch((error) => {
                        console.error('Erro ao carregar locais:', error);
                        locationsContainer.innerHTML = '<p class="load-error">Erro ao carregar locais. Por favor, recarregue a página.</p>';
                    });
            }
            
            // Função para atualizar o contador de contribuições do usuário
            function updateUserContributionCount() {
                const user = firebase.auth().currentUser;
                if (!user) return;
                
                firebase.firestore().collection('accessibleLocations')
                    .where('userId', '==', user.uid)
                    .get()
                    .then((querySnapshot) => {
                        const contributionCount = querySnapshot.size;
                        const contributionsElement = document.querySelector('.stat-card:nth-child(3) .stat-content p');
                        if (contributionsElement) {
                            contributionsElement.textContent = contributionCount;
                        }
                    })
                    .catch((error) => {
                        console.error('Erro ao atualizar contagem de contribuições:', error);
                    });
            }
            
            // Inicializar: carregar locais quando o usuário estiver autenticado
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    loadLocations();
                    updateUserContributionCount();
                }
            });
        });
    </script>
    
    <!-- Auth state navbar handling -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get navbar elements
            const navLinks = document.querySelector('.nav-links');
            const navLinksMobile = document.querySelector('.nav-links-mobile');
            
            // Remove unnecessary links from authenticated pages
            const removeUnnecessaryLinks = () => {
                // Function to safely remove links that shouldn't be visible on authenticated pages
                const removeLink = (parentElement, hrefValue) => {
                    const links = parentElement.querySelectorAll(`a[href="${hrefValue}"]`);
                    links.forEach(link => {
                        const listItem = link.parentElement;
                        if (listItem && listItem.tagName === 'LI') {
                            listItem.remove();
                        }
                    });
                };
                
                // Remove these links as they don't make sense in an authenticated context or are handled elsewhere
                removeLink(navLinks, '#mapa');
                removeLink(navLinks, '#contribuir');
                removeLink(navLinksMobile, '#mapa');
                removeLink(navLinksMobile, '#contribuir');
            };
            
            // Clean up navbar for authenticated users
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    // User is authenticated, clean up navbar
                    removeUnnecessaryLinks();
                } else {
                    // User is not authenticated, redirect to login page
                    // This is already handled in firebase-dashboard.js
                }
            });
        });
    </script>
    
    <!-- Google Maps Script (carregado dinamicamente com a API key do env-config.js) -->
    <script>
        // Função para carregar a API do Google Maps com a chave das variáveis de ambiente
        function loadGoogleMapsScript() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${window.ENV.GOOGLE_MAPS_API_KEY}&libraries=places&callback=initMap`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
        
        // Variáveis globais para os mapas
        window.mainMap = undefined;
        window.mainMapMarkers = [];
        let mainMapMarkers = window.mainMapMarkers; // manter referência para compatibilidade
        
        // Inicializar mapa principal
        function initMap() {
            // --- Adiciona sincronização do tema do mapa principal ---
            const darkMapStyles = [
                { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
                { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
                { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#263c3f" }] },
                { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#6b9a76" }] },
                { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
                { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
                { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
                { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] },
                { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }] },
                { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#f3d19c" }] },
                { featureType: "transit", elementType: "geometry", stylers: [{ color: "#2f3948" }] },
                { featureType: "transit.station", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
                { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
                { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#515c6d" }] },
                { featureType: "water", elementType: "labels.text.stroke", stylers: [{ color: "#17263c" }] }
            ];
            // Listener para troca de tema
            document.removeEventListener('themechange', window._wacs_main_map_theme_listener);
            window._wacs_main_map_theme_listener = function() {
                if (window.mainMap) {
                    const isDark = document.body.classList.contains('dark-theme');
                    window.mainMap.setOptions({ styles: isDark ? darkMapStyles : [] });
                }
            };
            document.addEventListener('themechange', window._wacs_main_map_theme_listener);

            // Configuração do mapa principal na dashboard
            const mapContainer = document.querySelector('.map-container');
            if (mapContainer) {
                mapContainer.innerHTML = ''; // Limpar o conteúdo de placeholder
                
                const mapOptions = {
                    center: { lat: -24.4874, lng: -47.8446 }, // Registro, SP
                    zoom: 14,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    mapTypeControl: true,
                    streetViewControl: false,
                    fullscreenControl: true
                };
                
                window.mainMap = new google.maps.Map(mapContainer, mapOptions);
                
                // Aplica o estilo correto no carregamento inicial
                const isDark = document.body.classList.contains('dark-theme');
                window.mainMap.setOptions({ styles: isDark ? darkMapStyles : [] });
                
                // Carregar os locais acessíveis para o mapa
                loadLocationsForMap();
            }
        }
        
        // Função para carregar os locais no mapa principal
        function loadLocationsForMap() {
            if (!window.mainMap) return;
            
            // Limpar marcadores existentes
            window.mainMapMarkers.forEach(marker => marker.setMap(null));
            window.mainMapMarkers = [];
            
            // Buscar locais no Firestore
            firebase.firestore().collection('accessibleLocations')
                .get()
                .then((querySnapshot) => {
                    const bounds = new google.maps.LatLngBounds();
                    let hasLocations = false;
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.location) {
                            hasLocations = true;
                            const position = {
                                lat: data.location.latitude,
                                lng: data.location.longitude
                            };
                            
                            // Criar marcador
                            const marker = new google.maps.Marker({
                                position: position,
                                map: window.mainMap,
                                title: data.name,
                                animation: google.maps.Animation.DROP
                            });
                            
                            // Formatação para rating
                            const rating = data.rating || 0;
                            const reviewCount = data.reviewCount || 0;
                            let ratingStars = '';
                            
                            // Gerar estrelas HTML
                            for (let i = 1; i <= 5; i++) {
                                if (i <= Math.floor(rating)) {
                                    ratingStars += '<i class="fas fa-star" style="color: #fbbf24;"></i>';
                                } else if (i === Math.ceil(rating) && rating % 1 !== 0) {
                                    ratingStars += '<i class="fas fa-star-half-alt" style="color: #fbbf24;"></i>';
                                } else {
                                    ratingStars += '<i class="far fa-star" style="color: #d1d5db;"></i>';
                                }
                            }
                            
                            // Criar janela de informações
                            const infowindow = new google.maps.InfoWindow({
                                content: `
                                    <div class="map-info-window">
                                        <h3>${data.name}</h3>
                                        <p>${data.address}</p>
                                        <p><strong>Recursos:</strong> ${data.features}</p>
                                        <div style="margin-top:8px;">
                                            ${ratingStars}
                                            <span style="margin-left:6px;font-size:13px;">
                                                ${rating.toFixed(1)} (${reviewCount} ${reviewCount === 1 ? 'avaliação' : 'avaliações'})
                                            </span>
                                        </div>
                                    </div>
                                `
                            });
                            
                            // Abrir janela de informações ao clicar no marcador
                            marker.addListener('click', function() {
                                infowindow.open(window.mainMap, marker);
                            });
                            
                            // Adicionar à coleção de marcadores
                            window.mainMapMarkers.push(marker);
                            
                            // Extender os limites do mapa para incluir este marcador
                            bounds.extend(position);
                        }
                    });
                    
                    // Ajustar o mapa para mostrar todos os marcadores
                    if (hasLocations) {
                        window.mainMap.fitBounds(bounds);
                        
                        // Definir um zoom máximo para não aproximar demais se houver apenas um ou poucos locais
                        const listener = google.maps.event.addListener(window.mainMap, 'idle', function() {
                            if (window.mainMap.getZoom() > 16) {
                                window.mainMap.setZoom(16);
                            }
                            google.maps.event.removeListener(listener);
                        });
                    }
                })
                .catch((error) => {
                    console.error('Erro ao carregar locais para o mapa:', error);
                });
        }
        
        // Função para atualizar o mapa principal (chamada após adicionar um novo local)
        function updateMainMap() {
            if (mainMap) {
                loadLocationsForMap();
            }
        }
        
        // Aguardar o carregamento das variáveis de ambiente antes de carregar o Google Maps
        if (window.ENV && window.ENV.GOOGLE_MAPS_API_KEY) {
            loadGoogleMapsScript();
        } else {
            window.addEventListener('DOMContentLoaded', function() {
                if (window.ENV && window.ENV.GOOGLE_MAPS_API_KEY) {
                    loadGoogleMapsScript();
                } else {
                    console.error('Google Maps API key não encontrada nas variáveis de ambiente');
                }
            });
        }
    </script>

    <script>
        // ... existing code ...
        function addLocationToUI(location) {
            const locationCard = document.createElement('div');
            locationCard.className = 'location-card';
            locationCard.dataset.id = location.id;
            
            // Calcular ou usar a avaliação existente
            const rating = location.rating || 0;
            const reviewCount = location.reviewCount || 0;
            
            locationCard.innerHTML = `
                <div class="location-image">
                    ${location.imageUrl.includes('placeholder') 
                        ? '<i class="fas fa-image"></i> Imagem do Local' 
                        : `<img src="${location.imageUrl}" alt="${location.name}">`}
                </div>
                <div class="location-details">
                    <h3>${location.name}</h3>
                    <p>${location.address}</p>
                    <p class="location-author">
                        Adicionado por: <a href="#" class="user-link" data-user-id="${location.userId}">${location.userName}</a>
                    </p>
                    <div class="accessibility-features">
                        ${(location.accessibilityFeatures || []).map(feature => {
                            const icons = {
                                'wheelchair': '<i class="fas fa-wheelchair" title="Cadeira de Rodas"></i>',
                                'blind': '<i class="fas fa-walking" title="Piso Tátil"></i>',
                                'deaf': '<i class="fas fa-arrow-up-right-from-square" title="Rampa"></i>',
                                'elevator': '<i class="fas fa-elevator" title="Elevador"></i>',
                                'parking': '<i class="fas fa-restroom" title="Banheiro Adaptado"></i>'
                            };
                            return icons[feature] || '';
                        }).join(' ')}
                    </div>
                    <div class="location-rating">
                        ${renderRatingStars(rating)}
                        <span>${rating.toFixed(1)} (${formatReviewText(reviewCount)})</span>
                    </div>
                    <button class="rate-button" data-id="${location.id}" data-name="${location.name}" data-address="${location.address}">
                        <i class="fas fa-star"></i> Avaliar Local
                    </button>
                    <div class="last-review" id="last-review-${location.id}">
                        <p>Carregando última avaliação...</p>
                    </div>
                    ${reviewCount > 0 ? `
                        <button class="view-all-reviews-btn" data-id="${location.id}" data-name="${location.name}">
                            Ver todas as avaliações <i class="fas fa-chevron-right"></i>
                        </button>
                    ` : ''}
                </div>
            `;
            
            // Adicionar no início da lista
            if (locationsContainer.firstChild) {
                locationsContainer.insertBefore(locationCard, locationsContainer.firstChild);
            } else {
                locationsContainer.appendChild(locationCard);
            }
            
            // Adicionar evento ao botão de avaliação
            const rateButton = locationCard.querySelector('.rate-button');
            if (rateButton) {
                rateButton.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const name = this.getAttribute('data-name');
                    const address = this.getAttribute('data-address');
                    openRateModal(id, name, address);
                });
            }
            
            // Adicionar evento ao botão de ver todas as avaliações
            const viewAllReviewsBtn = locationCard.querySelector('.view-all-reviews-btn');
            if (viewAllReviewsBtn) {
                viewAllReviewsBtn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const name = this.getAttribute('data-name');
                    openAllReviewsModal(id, name);
                });
            }
            
            // Carregar a última avaliação
            loadLastReview(location.id);
        }

        // Função para abrir o modal com todas as avaliações
        function openAllReviewsModal(locationId, locationName) {
            const modal = document.getElementById('allReviewsModal');
            const reviewsList = document.getElementById('allReviewsList');
            const locationInfo = document.getElementById('locationReviewsInfo');
            const closeModalBtn = modal.querySelector('.close-modal');
            
            // Limpar conteúdo anterior
            reviewsList.innerHTML = '<p>Carregando avaliações...</p>';
            
            // Mostrar informações do local
            locationInfo.innerHTML = `
                <h3>${locationName}</h3>
                <p>Carregando avaliações...</p>
            `;
            
            // Abrir modal
            modal.style.display = 'block';
            
            // Adicionar evento de fechamento ao botão X
            closeModalBtn.onclick = function() {
                modal.style.display = 'none';
            };
            
            // Buscar informações do local para obter os recursos de acessibilidade
            db.collection('accessibleLocations').doc(locationId).get()
                .then(locationDoc => {
                    if (!locationDoc.exists) {
                        throw new Error('Local não encontrado');
                    }
                    
                    const locationData = locationDoc.data();
                    const accessibilityFeatures = locationData.accessibilityFeatures || [];
                    
                    // Mapear recursos para ícones e nomes
                    const featureMap = {
                        'wheelchair': { icon: 'fa-wheelchair', name: 'Cadeira de Rodas' },
                        'blind': { icon: 'fa-walking', name: 'Piso Tátil' },
                        'deaf': { icon: 'fa-arrow-up-right-from-square', name: 'Rampa' },
                        'elevator': { icon: 'fa-elevator', name: 'Elevador' },
                        'parking': { icon: 'fa-restroom', name: 'Banheiro Adaptado' }
                    };
                    
                    // Agora carregar todas as avaliações para este local
                    return db.collection('reviews')
                        .where('locationId', '==', locationId)
                        .get()
                        .then((querySnapshot) => {
                            if (querySnapshot.empty) {
                                reviewsList.innerHTML = '<p class="no-reviews">Nenhuma avaliação ainda.</p>';
                                locationInfo.innerHTML = `
                                    <h3>${locationName}</h3>
                                    <p>Nenhuma avaliação ainda.</p>
                                `;
                                return;
                            }
                            
                            // Ordenar avaliações por data
                            const reviews = querySnapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            })).sort((a, b) => {
                                const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                                const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                                return dateB - dateA;
                            });
                            
                            // Calcular médias
                            const averageRating = reviews.reduce((acc, review) => acc + review.rating, 0) / reviews.length;
                            
                            // Calcular médias por recurso de acessibilidade
                            const featureRatingTotals = {};
                            const featureRatingCounts = {};
                            
                            reviews.forEach(review => {
                                if (review.featureRatings) {
                                    Object.entries(review.featureRatings).forEach(([feature, rating]) => {
                                        featureRatingTotals[feature] = (featureRatingTotals[feature] || 0) + rating;
                                        featureRatingCounts[feature] = (featureRatingCounts[feature] || 0) + 1;
                                    });
                                }
                            });
                            
                            // Calcular médias finais
                            const featureAverages = {};
                            Object.keys(featureRatingTotals).forEach(feature => {
                                featureAverages[feature] = featureRatingTotals[feature] / featureRatingCounts[feature];
                            });
                            
                            // Atualizar informações do local
                            let featuresHTML = '';
                            accessibilityFeatures.forEach(feature => {
                                if (featureMap[feature] && featureAverages[feature]) {
                                    const average = featureAverages[feature];
                                    featuresHTML += `
                                        <div class="feature-rating-badge">
                                            <i class="fas ${featureMap[feature].icon}"></i>
                                            <span class="feature-name">${featureMap[feature].name}</span>:
                                            <span class="feature-stars">${renderRatingStars(average, 'small')}</span>
                                            <span>(${average.toFixed(1)})</span>
                                        </div>
                                    `;
                                }
                            });
                            
                            locationInfo.innerHTML = `
                                <h3>${locationName}</h3>
                                <p>Média: ${averageRating.toFixed(1)} (${reviews.length} ${reviews.length === 1 ? 'avaliação' : 'avaliações'})</p>
                                <div class="feature-ratings-detail">
                                    ${featuresHTML}
                                </div>
                            `;
                            
                            // Renderizar lista de avaliações
                            reviewsList.innerHTML = reviews.map(review => {
                                const date = review.createdAt ? new Date(review.createdAt.toDate()) : new Date();
                                const formattedDate = date.toLocaleDateString('pt-BR');
                                
                                // Gerar badges para cada recurso avaliado
                                let featureRatingsHTML = '';
                                if (review.featureRatings && Object.keys(review.featureRatings).length > 0) {
                                    featureRatingsHTML = '<div class="feature-ratings-detail">';
                                    
                                    Object.entries(review.featureRatings).forEach(([feature, rating]) => {
                                        if (featureMap[feature]) {
                                            featureRatingsHTML += `
                                                <div class="feature-rating-badge">
                                                    <i class="fas ${featureMap[feature].icon}"></i>
                                                    <span class="feature-name">${featureMap[feature].name}</span>:
                                                    <div class="feature-stars">
                                                        ${Array(rating).fill('<i class="fas fa-star"></i>').join('')}
                                                    </div>
                                                </div>
                                            `;
                                        }
                                    });
                                    
                                    featureRatingsHTML += '</div>';
                                }
                                
                                return `
                                    <div class="review-item-full">
                                        <div class="review-header">
                                            <span class="review-author">${review.userName}</span>
                                            <span class="review-date">${formattedDate}</span>
                                        </div>
                                        <div class="review-stars">
                                            ${renderRatingStars(review.rating)}
                                        </div>
                                        ${review.comment ? `<p class="review-text">${review.comment}</p>` : ''}
                                        ${featureRatingsHTML}
                                    </div>
                                `;
                            }).join('');
                        });
                })
                .catch((error) => {
                    console.error('Erro ao carregar avaliações:', error);
                    reviewsList.innerHTML = '<p class="review-error">Erro ao carregar avaliações. Por favor, tente novamente.</p>';
                    locationInfo.innerHTML = `
                        <h3>${locationName}</h3>
                        <p class="review-error">Erro ao carregar avaliações: ${error.message}</p>
                    `;
                });
        }
        // ... existing code ...
    </script>

    <script>
        // ... existing code ...
        
        // Função para formatar os textos de avaliação
        function formatReviewText(count) {
            if (count === 0) return "Sem avaliações";
            if (count === 1) return "1 avaliação";
            return `${count} avaliações`;
        }
        
        // Verificar se o usuário está logado e inicializar chat
        document.addEventListener('DOMContentLoaded', function() {
            // Referência para os elementos do chat
            const chatMessages = document.getElementById('chatMessages');
            const messageInput = document.getElementById('chatMessageInput');
            const sendButton = document.getElementById('sendMessageBtn');
            
            // Variáveis para o Firebase
            let db, auth, currentUser;
            
            // Inicializar Firebase para o chat
            function initChat() {
                if (firebase) {
                    auth = firebase.auth();
                    db = firebase.firestore();
                    
                    // Observar estado de autenticação
                    auth.onAuthStateChanged(function(user) {
                        if (user) {
                            currentUser = user;
                            loadChatMessages();
                            setupChatListeners();
                            addDeleteAllButton(); // Adicionar botão de apagar todas as mensagens
                        } else {
                            // Usuário não logado
                            chatMessages.innerHTML = `
                                <div class="system-message">
                                    <p>Você precisa estar logado para usar o chat.</p>
                            </div>
                        `;
                        }
                    });
                }
            }
            
            // Carregar mensagens existentes
            function loadChatMessages() {
                db.collection('chatMessages')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get()
                    .then((querySnapshot) => {
                        // Limpar mensagens existentes
                        chatMessages.innerHTML = '';
                        
                        // Organizar mensagens em ordem cronológica
                        const messages = [];
                        querySnapshot.forEach((doc) => {
                            messages.push({id: doc.id, ...doc.data()});
                        });
                        
                        // Obter fotos de perfil para mensagens antigas que não possuem essa informação
                        const messagePromises = messages.map(async (message) => {
                            if (!message.photoURL && message.userId) {
                                try {
                                    // Buscar dados do usuário para obter a foto de perfil
                                    const userDoc = await db.collection('users').doc(message.userId).get();
                                    if (userDoc.exists) {
                                        const userData = userDoc.data();
                                        if (userData.photoURL) {
                                            message.photoURL = userData.photoURL;
                                        }
                                    }
                                } catch (error) {
                                    console.error("Erro ao buscar foto de perfil:", error);
                                }
                            }
                            return message;
                        });
                        
                        // Quando todas as promessas forem resolvidas
                        Promise.all(messagePromises).then(updatedMessages => {
                            // Exibir em ordem cronológica (da mais antiga para a mais recente)
                            updatedMessages.reverse().forEach(message => {
                                addMessageToUI(message);
                            });
                            
                            // Rolar para a mensagem mais recente
                            scrollToBottom();
                            
                            // Se não houver mensagens, mostrar mensagem inicial
                            if (updatedMessages.length === 0) {
                                chatMessages.innerHTML = `
                                    <div class="system-message">
                                        <p>Ainda não há mensagens. Seja o primeiro a iniciar uma conversa!</p>
                                    </div>
                                `;
                            }
                        });
                    })
                    .catch((error) => {
                        console.error("Erro ao carregar mensagens do chat:", error);
                        chatMessages.innerHTML = `
                            <div class="system-message">
                                <p>Erro ao carregar mensagens. Por favor, tente novamente.</p>
                        </div>
                    `;
                    });
            }
            
            // Configurar ouvinte para novas mensagens
            function setupChatListeners() {
                // Ouvir por novas mensagens em tempo real
                db.collection('chatMessages')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added') {
                                // Nova mensagem adicionada
                                const message = {id: change.doc.id, ...change.doc.data()};
                                
                                // Verificar se a mensagem já está na UI (para evitar duplicatas)
                                if (!document.getElementById(`message-${message.id}`)) {
                                    // Verificar se a mensagem tem a URL da foto e, caso não tenha, buscar
                                    if (!message.photoURL && message.userId) {
                                        db.collection('users').doc(message.userId).get()
                                            .then(userDoc => {
                                                if (userDoc.exists) {
                                                    const userData = userDoc.data();
                                                    if (userData.photoURL) {
                                                        message.photoURL = userData.photoURL;
                                                    }
                                                }
                                                addMessageToUI(message);
                                                scrollToBottom();
                                            })
                                            .catch(error => {
                                                console.error("Erro ao buscar foto do usuário:", error);
                                                addMessageToUI(message);
                                                scrollToBottom();
                                            });
                                    } else {
                                        addMessageToUI(message);
                                        scrollToBottom();
                                    }
                                }
                            } else if (change.type === 'modified') {
                                // Mensagem modificada (ex: apagada)
                                const message = {id: change.doc.id, ...change.doc.data()};
                                const messageElement = document.getElementById(`message-${message.id}`);
                                
                                // Se a mensagem foi apagada, atualizar na UI
                                if (message.deleted && messageElement) {
                                    const messageText = messageElement.querySelector('.message-text');
                                    if (messageText) {
                                        messageText.innerHTML = `<i class="fas fa-ban"></i> Esta mensagem foi apagada`;
                                        messageText.classList.add('deleted-message');
                                    }
                                    
                                    // Remover o botão de apagar se existir
                                    const deleteBtn = messageElement.querySelector('.message-delete-btn');
                                    if (deleteBtn) {
                                        deleteBtn.remove();
                                    }
                                }
                            }
                        });
                    }, (error) => {
                        console.error("Erro no listener de mensagens:", error);
                    });
                
                // Adicionar evento para o botão de enviar
                sendButton.addEventListener('click', sendMessage);
                
                // Adicionar evento para enviar mensagem com Enter (não shift+enter)
                messageInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            // Enviar nova mensagem
            function sendMessage() {
                const messageText = messageInput.value.trim();
                
                if (messageText && currentUser) {
                    // Desabilitar botão para evitar envios duplicados
                    sendButton.disabled = true;
                    
                    // Primeiro, buscar o número da última mensagem
                    db.collection('chatMessages')
                        .orderBy('messageNumber', 'desc')
                        .limit(1)
                        .get()
                        .then((querySnapshot) => {
                            let nextMessageNumber = 1; // Valor padrão para primeira mensagem
                            
                            if (!querySnapshot.empty) {
                                const lastMessage = querySnapshot.docs[0].data();
                                nextMessageNumber = (lastMessage.messageNumber || 0) + 1;
                            }
                            
                            // Criar objeto de mensagem
                            const message = {
                                text: messageText,
                                userId: currentUser.uid,
                                userName: currentUser.displayName || 'Usuário',
                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                userEmail: currentUser.email,
                                photoURL: currentUser.photoURL || '',
                                messageNumber: nextMessageNumber
                            };
                            
                            // Criar ID do documento com o número da mensagem
                            const messageId = `mensagem${String(nextMessageNumber).padStart(2, '0')}`;
                            
                            // Salvar no Firestore com ID personalizado
                            return db.collection('chatMessages').doc(messageId).set(message);
                        })
                        .then(() => {
                            // Limpar input após envio bem-sucedido
                            messageInput.value = '';
                            sendButton.disabled = false;
                        })
                        .catch((error) => {
                            console.error("Erro ao enviar mensagem:", error);
                            alert("Erro ao enviar mensagem. Tente novamente.");
                            sendButton.disabled = false;
                        });
                }
            }
            
            // Adicionar mensagem à interface
            function addMessageToUI(message) {
                const isCurrentUser = currentUser && message.userId === currentUser.uid;
                const messageElement = document.createElement('div');
                messageElement.className = `chat-message ${isCurrentUser ? 'sent' : 'received'}`;
                messageElement.id = `message-${message.id}`;
                messageElement.setAttribute('data-message-id', message.id);
                
                // Verificar se a mensagem foi apagada
                const isDeleted = message.deleted === true;
                
                // Formatar horário
                const timestamp = message.timestamp ? message.timestamp.toDate() : new Date();
                const timeFormatted = timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Gerar conteúdo da foto de perfil
                let photoContent = '';
                
                if (message.photoURL) {
                    photoContent = `<div class="sender-photo" style="background-image: url('${message.photoURL}')"></div>`;
                } else {
                    // Se não tiver foto, mostrar as iniciais ou ícone
                    if (message.userName && message.userName !== 'Usuário') {
                        const initials = message.userName.split(' ').map(name => name[0]).join('').toUpperCase();
                        photoContent = `<div class="sender-photo">${initials}</div>`;
                    } else {
                        photoContent = `<div class="sender-photo"><i class="fas fa-user" style="font-size: 0.7rem"></i></div>`;
                    }
                }
                
                // Criar HTML da mensagem com base no status (apagada ou não)
                let messageText = '';
                if (isDeleted) {
                    messageText = `<p class="message-text deleted-message"><i class="fas fa-ban"></i> Esta mensagem foi apagada</p>`;
                } else if (message.type === 'image' && message.imageUrl) {
                    messageText = `<div class="message-image"><img src="${message.imageUrl}" alt="Imagem enviada" style="width:200px; height:200px; border-radius:10px; object-fit:cover; box-shadow:0 1px 8px #0002; background:#eee;" /></div>`;
                } else {
                    messageText = `<p class="message-text">${escapeHtml(message.text)}</p>`;
                }
                
                // Adicionar botão de apagar apenas se for do usuário atual e não estiver apagada
                if (!isDeleted && isCurrentUser) {
                    messageText += `<div class="message-delete-btn" data-message-id="${message.id}"><i class="fas fa-trash-alt"></i></div>`;
                }
                
                // Criar HTML da mensagem
                if (isCurrentUser) {
                    messageElement.innerHTML = `
                        <div class="sender-info">
                            ${photoContent}
                            <span class="user-link" data-user-id="${message.userId}">${message.userName || 'Usuário'}</span>
                        </div>
                        <div class="message-content">
                            ${messageText}
                            <div class="message-time">${timeFormatted}</div>
                        </div>
                    `;
                } else {
                    messageElement.innerHTML = `
                        <div class="sender-info">
                            ${photoContent}
                            <span class="user-link" data-user-id="${message.userId}">${message.userName || 'Usuário'}</span>
                        </div>
                        <div class="message-content">
                            ${messageText}
                            <div class="message-time">${timeFormatted}</div>
                        </div>
                    `;
                }
                
                // Adicionar ao container
                chatMessages.appendChild(messageElement);
                
                // Adicionar evento para o botão de apagar, se a mensagem não estiver apagada
                if (!isDeleted && isCurrentUser) {
                    const deleteBtn = messageElement.querySelector('.message-delete-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', function() {
                            const messageId = this.getAttribute('data-message-id');
                            if (confirm('Tem certeza que deseja apagar esta mensagem?')) {
                                deleteMessage(messageId);
                            }
                        });
                    }
                }
            }
            
            // Função auxiliar para escapar HTML (evitar injeção de código)
            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
            
            // Rolar chat para a última mensagem
            function scrollToBottom() {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Função para apagar uma mensagem
            function deleteMessage(messageId) {
                if (!messageId || !currentUser) return;
                
                // Buscar a mensagem primeiro para confirmar que é do usuário atual ou se é admin
                db.collection('chatMessages').doc(messageId).get()
                    .then(doc => {
                        if (doc.exists) {
                            const message = doc.data();
                            
                            // Verificar se é admin
                            return db.collection('users').doc(currentUser.uid).get()
                                .then(userDoc => {
                                    const userData = userDoc.data();
                                    const isAdmin = userData && userData.ADM === 1;
                                    
                                    // Permitir apagar se for o dono da mensagem ou se for admin
                                    if (message.userId === currentUser.uid || isAdmin) {
                                        // Excluir completamente o documento do Firestore
                                        return db.collection('chatMessages').doc(messageId).delete();
                                    } else {
                                        throw new Error('Você não tem permissão para apagar esta mensagem');
                                    }
                                });
                        } else {
                            throw new Error('Mensagem não encontrada');
                        }
                    })
                    .then(() => {
                        console.log('Mensagem excluída com sucesso');
                        
                        // Remover a mensagem da UI
                        const messageElement = document.getElementById(`message-${messageId}`);
                        if (messageElement) {
                            messageElement.remove();
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao excluir mensagem:', error);
                        alert('Erro ao excluir mensagem: ' + error.message);
                    });
            }
            
            // Função para apagar todas as mensagens (apenas para admins)
            function deleteAllMessages() {
                if (!currentUser) return;
                
                // Verificar se é admin
                db.collection('users').doc(currentUser.uid).get()
                    .then(userDoc => {
                        const userData = userDoc.data();
                        if (userData && userData.ADM === 1) {
                            if (confirm('Tem certeza que deseja apagar TODAS as mensagens do chat? Esta ação não pode ser desfeita.')) {
                                // Buscar todas as mensagens
                                return db.collection('chatMessages').get()
                                    .then(snapshot => {
                                        const batch = db.batch();
                                        snapshot.forEach(doc => {
                                            batch.update(doc.ref, {
                                                deleted: true,
                                                deletedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                                deletedBy: currentUser.uid
                                            });
                                        });
                                        return batch.commit();
                                    })
                                    .then(() => {
                                        showAlert('Todas as mensagens foram apagadas com sucesso!', 'success');
                                    });
                            }
                        } else {
                            throw new Error('Apenas administradores podem apagar todas as mensagens');
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao apagar todas as mensagens:', error);
                        showAlert('Erro ao apagar mensagens: ' + error.message, 'error');
                    });
            }

            // Adicionar botão de apagar todas as mensagens para admins
            function addDeleteAllButton() {
                // Verificar se o usuário é admin
                db.collection('users').doc(currentUser.uid).get()
                    .then(userDoc => {
                        const userData = userDoc.data();
                        const isAdmin = userData && userData.ADM === 1;
                        
                        if (isAdmin) {
                            // Criar botão de apagar todas as mensagens
                            const deleteAllBtn = document.createElement('button');
                            deleteAllBtn.className = 'delete-all-btn';
                            deleteAllBtn.innerHTML = '<i class="fas fa-trash"></i> Apagar todas as mensagens';
                            deleteAllBtn.style.marginTop = '1rem';
                            deleteAllBtn.style.padding = '0.5rem 1rem';
                            deleteAllBtn.style.backgroundColor = '#dc3545';
                            deleteAllBtn.style.color = 'white';
                            deleteAllBtn.style.border = 'none';
                            deleteAllBtn.style.borderRadius = '4px';
                            deleteAllBtn.style.cursor = 'pointer';
                            
                            // Adicionar evento de clique
                            deleteAllBtn.addEventListener('click', function() {
                                if (confirm('Tem certeza que deseja apagar TODAS as mensagens do chat? Esta ação não pode ser desfeita.')) {
                                    deleteAllMessages();
                                }
                            });
                            
                            // Adicionar botão após o container do chat
                            const chatContainer = document.querySelector('.chat-container');
                            chatContainer.parentNode.insertBefore(deleteAllBtn, chatContainer.nextSibling);
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao verificar permissões de admin:', error);
                    });
            }
            
            // Função para apagar todas as mensagens
            function deleteAllMessages() {
                // Buscar todas as mensagens
                db.collection('chatMessages').get()
                    .then(querySnapshot => {
                        // Criar um array de promessas para excluir cada mensagem
                        const deletePromises = querySnapshot.docs.map(doc => {
                            return doc.ref.delete();
                        });
                        
                        // Executar todas as exclusões
                        return Promise.all(deletePromises);
                    })
                    .then(() => {
                        console.log('Todas as mensagens foram excluídas com sucesso');
                        // Limpar a UI
                        chatMessages.innerHTML = `
                            <div class="system-message">
                                <p>Nenhuma mensagem no chat.</p>
                            </div>
                        `;
                    })
                    .catch(error => {
                        console.error('Erro ao excluir todas as mensagens:', error);
                        alert('Erro ao excluir todas as mensagens: ' + error.message);
                    });
            }
            
            // Inicializar chat se o Firebase estiver disponível
            if (window.firebase) {
                initChat();
            }

// --- LÓGICA DE UPLOAD DE IMAGEM NO CHAT ---
console.log('[Chat] Registrando lógica de upload de imagem no chat');

// Referências aos elementos do DOM
const chatImageInput = document.getElementById('chatImageInput');
const chatImageBtn = document.getElementById('chatImageBtn');

if (!chatImageBtn) {
    console.warn('[Chat] Botão de anexar imagem (chatImageBtn) não encontrado!');
}
if (!chatImageInput) {
    console.warn('[Chat] Input de imagem (chatImageInput) não encontrado!');
}

if (chatImageBtn && chatImageInput) {
    console.log('[Chat] Botão e input de imagem encontrados. Configurando event listeners...');
    
    // Usar addEventListener em vez de onclick para melhor compatibilidade
    chatImageBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('[Chat] Botão de anexar imagem clicado');
        
        // Tenta abrir o seletor de arquivos
        chatImageInput.click();
        
        // Fallback: se após 1s o input não ganhar foco, exibe o input
        setTimeout(function() {
            if (document.activeElement !== chatImageInput) {
                console.warn('[Chat] Fallback: chatImageInput não recebeu foco. Mostrando o input manualmente.');
                chatImageInput.style.display = 'block';
                chatImageInput.style.position = 'relative';
                chatImageInput.style.zIndex = '9999';
                alert('Não foi possível abrir o seletor automaticamente. Selecione o arquivo manualmente.');
            }
        }, 1000);
    });
    
    // Handler para quando um arquivo é selecionado
    chatImageInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const user = firebase.auth().currentUser;
        if (!user) {
            alert('É necessário estar logado para enviar imagens.');
            return;
        }
        
        const sendButtonRef = document.getElementById('sendMessageBtn');
        
        // Desabilitar botões durante o upload
        if(sendButtonRef) sendButtonRef.disabled = true;
        chatImageBtn.disabled = true;
        
        try {
            // Upload para o Firebase Storage
            const storageRef = firebase.storage().ref(`chatImages/${user.uid}_${Date.now()}`);
            await storageRef.put(file);
            const imageUrl = await storageRef.getDownloadURL();
            
            // Buscar a última mensagem para obter o próximo número
            const lastMessageQuery = await firebase.firestore()
                .collection('chatMessages')
                .orderBy('messageNumber', 'desc')
                .limit(1)
                .get();

            let nextMessageNumber = 1; // Valor padrão para primeira mensagem
            
            if (!lastMessageQuery.empty) {
                const lastMessage = lastMessageQuery.docs[0].data();
                nextMessageNumber = (lastMessage.messageNumber || 0) + 1;
            }
            
            // Criar ID do documento com o número da mensagem
            const messageId = `mensagem${String(nextMessageNumber).padStart(2, '0')}`;
            
            // Adicionar mensagem com imagem ao Firestore
            await firebase.firestore().collection('chatMessages').doc(messageId).set({
                type: 'image',
                imageUrl,
                userId: user.uid,
                userName: user.displayName || user.email || 'Usuário',
                userEmail: user.email || '',
                photoURL: user.photoURL || '',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                messageNumber: nextMessageNumber
            });
            
            console.log('[Chat] Imagem enviada com sucesso');
        } catch (err) {
            alert('Erro ao enviar imagem: ' + err.message);
            console.error('[Chat] Erro no upload/salvamento da imagem:', err);
        }
        
        // Limpar e reabilitar
        chatImageInput.value = '';
        if(sendButtonRef) sendButtonRef.disabled = false;
        chatImageBtn.disabled = false;
    };
} else {
    console.error('[Chat] FALHA CRÍTICA: chatImageBtn ou chatImageInput não foram encontrados. O botão de upload de imagem NÃO FUNCIONARÁ.');
}

}); // Fecha o document.addEventListener('DOMContentLoaded' do chat
    </script>

    <script>
        // ... existing code ...
        
        // Profile Modal Functionality
        const profileModal = document.getElementById('profileModal');
        const profileModalClose = document.getElementById('profileModalClose');
        const profilePhoto = document.getElementById('profilePhoto');
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const profileMessages = document.getElementById('profileMessages');
        const profileContributions = document.getElementById('profileContributions');

        // Close modal when clicking the close button or outside the modal
        profileModalClose.addEventListener('click', () => {
            profileModal.classList.remove('active');
        });

        profileModal.addEventListener('click', (e) => {
            if (e.target === profileModal) {
                profileModal.classList.remove('active');
            }
        });

        // Function to show user profile
        async function showUserProfile(userId) {
            try {
                // Get user data from Firestore
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    throw new Error('Usuário não encontrado');
                }

                const userData = userDoc.data();

                // Update modal content
                profileName.textContent = userData.displayName || 'Usuário';
                profileEmail.textContent = userData.email || '';

                // Update roles
                const rolesContainer = document.getElementById('profileRoles');
                rolesContainer.innerHTML = ''; // Clear existing roles

                // Add admin badge if user is admin
                if (userData.ADM === 1) {
                    const adminBadge = document.createElement('span');
                    adminBadge.className = 'role-badge admin-badge';
                    adminBadge.textContent = 'Administrador';
                    rolesContainer.appendChild(adminBadge);
                }

                // Add user role badge
                const userRole = userData.userRole || 'user';
                const roleBadge = document.createElement('span');
                roleBadge.className = 'role-badge user-badge';
                roleBadge.textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
                rolesContainer.appendChild(roleBadge);

                // Set profile photo
                if (userData.photoURL) {
                    profilePhoto.style.backgroundImage = `url('${userData.photoURL}')`;
                    profilePhoto.textContent = '';
                } else {
                    profilePhoto.style.backgroundImage = '';
                    const initials = (userData.displayName || 'U').split(' ').map(name => name[0]).join('').toUpperCase();
                    profilePhoto.textContent = initials;
                }

                // Get message count
                const messagesSnapshot = await db.collection('chatMessages')
                    .where('userId', '==', userId)
                    .get();
                profileMessages.textContent = messagesSnapshot.size;

                // Get locations count
                const locationsSnapshot = await db.collection('locations')
                    .where('addedBy', '==', userId)
                    .get();
                const locationsCount = locationsSnapshot.size;

                // Get reviews count
                const reviewsSnapshot = await db.collection('reviews')
                    .where('userId', '==', userId)
                    .get();
                const reviewsCount = reviewsSnapshot.size;

                // Update total contributions count
                const totalContributions = locationsCount + reviewsCount;
                profileContributions.textContent = totalContributions;

                // Update locations and reviews counts in the modal
                document.getElementById('modalUserLocations').textContent = locationsCount;
                document.getElementById('modalUserReviews').textContent = reviewsCount;

                // Show modal
                profileModal.classList.add('active');
            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
                alert('Erro ao carregar perfil do usuário');
            }
        }

        // Add click event listeners to user names
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('user-link')) {
                const userId = e.target.getAttribute('data-user-id');
                if (userId) {
                    showUserProfile(userId);
                }
            }
        });

        // ... existing code ...
    </script>
</body>
</html>

