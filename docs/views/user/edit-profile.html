<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WACS - Editar Perfil</title>
    <link rel="icon" href="../../public/images/logos-wacs/logo_padrao.png" type="image/png">
    <link rel="stylesheet" href="../../public/css/main.css">
    <link rel="stylesheet" href="../../public/css/navbar.css">
    <link rel="stylesheet" href="../../public/css/footer.css">
    <link rel="stylesheet" href="../../public/css/transitions.css">
    <link rel="stylesheet" href="../../public/css/forms.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        .edit-profile-page-content {
            max-width: 420px;
            margin: 0 auto;
            padding: 32px 0 48px 0;
        }
        .profile-edit-card {
            background: var(--card-background, #fff);
            border-radius: 18px;
            box-shadow: 0 2px 24px #0002;
            padding: 32px 28px 24px 28px;
            margin-top: 24px;
            margin-bottom: 32px;
        }
        .form-group {
            margin-bottom: 22px;
            display: flex;
            flex-direction: column;
            gap: 7px;
        }
        .form-group label {
            font-weight: 500;
            color: var(--text-color, #222);
            margin-bottom: 2px;
        }
        .form-group input,
        .form-group textarea {
            height: 48px;
            border-radius: 10px;
            border: 1.5px solid var(--border-color, #bbb);
            font-size: 1.08em;
            font-family: inherit;
            padding: 0 16px;
            box-shadow: 0 1px 4px #0001;
            outline: none;
            background: #fff;
            color: #111;
            transition: border-color 0.2s, box-shadow 0.2s, background 0.2s, color 0.2s;
        }
        body.dark .form-group input,
        body.dark .form-group textarea {
            background: #181a1b;
            color: #fff;
            border-color: #333;
        }
        .form-group textarea {
            min-height: 90px;
            height: auto;
            padding: 12px 16px;
            resize: vertical;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            border-color: var(--gradient-start, #2196f3);
            box-shadow: 0 2px 8px #0002;
        }
        .profile-picture-upload {
            align-items: center;
            gap: 12px;
        }
        .profile-picture-preview {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .profile-picture-preview img {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--gradient-start, #2196f3);
            box-shadow: 0 2px 12px #0002;
            background: var(--card-background, #fff);
            transition: border-color 0.2s;
        }
        #changeProfilePicBtn {
            height: 38px;
            padding: 0 18px;
            border-radius: 8px;
            font-size: 1em;
            margin-left: 0;
        }
        .password-section {
            margin-top: 32px;
            padding-top: 18px;
            border-top: 1.5px solid var(--border-color, #eee);
        }
        .password-section h3 {
            margin-bottom: 6px;
            font-size: 1.13em;
            font-weight: 600;
        }
        .section-description {
            font-size: 0.98em;
            color: var(--text-color, #888);
            margin-bottom: 12px;
        }
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 18px;
            justify-content: flex-end;
        }
        @media (max-width: 600px) {
            .edit-profile-page-content { padding: 18px 0 32px 0; }
            .profile-edit-card { padding: 18px 8px 16px 8px; }
            .profile-picture-preview img { width: 68px; height: 68px; }
        }
        .uf-cidade-row {
            display: flex;
            gap: 10px;
        }
        .uf-select, .autocomplete-cidade, .dropdown-btn {
            height: 48px;
            border-radius: 10px;
            border: 1.5px solid var(--border-color);
            font-size: 1.08em;
            font-family: inherit;
            padding: 0 16px;
            box-shadow: 0 1px 4px #0001;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s, background 0.2s, color 0.2s;
            margin-bottom: 0;
            margin-top: 0;
            display: flex;
            align-items: center;
            background: #fff;
            color: #111;
        }
        body.dark .uf-select, body.dark .autocomplete-cidade, body.dark .dropdown-btn {
            background: #181a1b !important;
            color: #fff !important;
            border-color: #333 !important;
        }
        .uf-select:focus, .autocomplete-cidade:focus, .dropdown-btn:focus {
            border-color: var(--gradient-start);
            box-shadow: 0 2px 8px #0002;
        }
        .autocomplete-cidade[disabled] {
            background: #f0f0f0 !important;
            color: #bbb !important;
            cursor: not-allowed;
        }
        .dropdown-list, .autocomplete-cidade-list {
            position: absolute;
            top: 110%;
            left: 0;
            width: 100%;
            background: #fff;
            border: 2px solid var(--gradient-start);
            border-radius: 12px;
            box-shadow: 0 8px 32px #0003;
            z-index: 20;
            animation: fadeInDropdown 0.18s;
            max-height: 260px;
            overflow-y: auto;
            font-size: 1.08em;
            padding: 6px 0;
        }
        body.dark .dropdown-list, body.dark .autocomplete-cidade-list {
            background: #181a1b !important;
            color: #fff !important;
            border-color: #333 !important;
        }
        .dropdown-item, .autocomplete-cidade-item {
            padding: 14px 22px;
            cursor: pointer;
            color: #111;
            background: none;
            font-weight: 500;
            border-radius: 8px;
            margin: 2px 8px;
            transition: background 0.15s, color 0.15s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        body.dark .dropdown-item, body.dark .autocomplete-cidade-item {
            color: #fff;
        }
        .dropdown-item:hover, .autocomplete-cidade-item:hover, .dropdown-item.selected, .autocomplete-cidade-item.selected {
            background: var(--gradient-bg-light, #e3f2fd);
            color: var(--gradient-start) !important;
        }
        body.dark .dropdown-item:hover, body.dark .autocomplete-cidade-item:hover, body.dark .dropdown-item.selected, body.dark .autocomplete-cidade-item.selected {
            background: #23272b;
            color: var(--gradient-start) !important;
        }
        .dropdown-list {
            border: 2px solid var(--gradient-start);
        }
        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        .chip {
            background: var(--gradient-bg-light, #e3f2fd);
            color: var(--gradient-start);
            border-radius: 16px;
            padding: 5px 14px 5px 10px;
            font-size: 0.98em;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            box-shadow: 0 1px 4px #0001;
            transition: background 0.18s, color 0.18s;
        }
        .chip:hover {
            background: var(--gradient-start);
            color: #fff;
        }
        .chip::after {
            content: 'Ã—';
            font-size: 1.1em;
            margin-left: 6px;
            opacity: 0.7;
        }
        .avatar-upload {
            position: relative;
            width: 96px;
            height: 96px;
            margin-bottom: 10px;
        }
        .avatar-upload img {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--gradient-start);
            box-shadow: 0 2px 12px #0002;
            background: var(--card-background);
            transition: border-color 0.2s;
        }
        .avatar-upload-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--gradient-start);
            color: #fff;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px #0002;
            font-size: 1.2em;
            transition: background 0.2s;
        }
        .avatar-upload-btn:hover {
            background: var(--gradient-end);
        }
        @media (max-width: 600px) {
            .uf-cidade-row { flex-direction: column; gap: 0; }
            .uf-select { width: 100%; max-width: 100%; }
            .avatar-upload, .avatar-upload img { width: 72px; height: 72px; }
            .avatar-upload-btn { width: 28px; height: 28px; font-size: 1em; }
        }
    </style>
</head>
<body class="fade-in">
    <div class="main-container">
        <nav class="navbar">
            <button class="menu-toggle-btn">
                <i class="fas fa-bars"></i>
            </button>
            <a href="../../index.html" class="navbar-logo" style="text-decoration:none; color:inherit;">
                <img src="../../public/images/logos-wacs/logo_padrao.png" alt="WACS Logo" style="height: 32px; width: auto; margin-right: 8px;">
                <span>WACS</span>
            </a>
            <ul class="navbar-menu">
                <li data-page="home"><a href="../../index.html">Home</a></li>
                <li data-page="recursos"><a href="../recursos.html">Recursos</a></li>
                <li data-page="comunidade"><a href="../comunidade.html">Comunidade</a></li>
                <li data-page="mapa"><a href="../mapa-acessivel.html">Mapa AcessÃ­vel</a></li>
                <li data-page="about"><a href="../about.html">Sobre</a></li>
            </ul>
            <div class="navbar-actions">
                <button class="theme-toggle-btn">
                    <i class="fas fa-sun"></i>
                </button>
                <!-- Nova estrutura para status de usuÃ¡rio em mobile -->
                <div class="mobile-user-status">
                    <img src="" alt="Foto de Perfil" class="profile-pic-mobile hidden">
                    <button class="btn btn-outline-gradient login-btn-mobile hidden" onclick="location.href='login.html'">Login</button>
                </div>
                <div class="logged-out-actions">
                    <button class="btn btn-gradient" onclick="location.href='login.html'">Acessar Plataforma</button>
                </div>
                <div class="logged-in-actions hidden">
                    <div class="user-profile">
                        <img src="" alt="Foto de Perfil" class="profile-pic">
                        <span class="user-name"></span>
                    </div>
                    <button class="btn btn-outline-gradient logout-btn">Sair</button>
                </div>
            </div>
        </nav>

        <!-- Mobile Menu Overlay (initially hidden) -->
        <div class="mobile-menu-overlay">
            <div class="mobile-menu-header">
                <a href="../../index.html" class="navbar-logo" style="text-decoration:none; color:inherit;">
                    <img src="../../public/images/logos-wacs/logo_padrao.png" alt="WACS Logo" style="height: 32px; width: auto; margin-right: 8px;">
                    <span>WACS</span>
                </a>
                <button class="close-menu-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <ul class="mobile-navbar-menu">
                <li data-page="home"><a href="../../index.html">Home</a></li>
                <li data-page="recursos"><a href="../recursos.html">Recursos</a></li>
                <li data-page="comunidade"><a href="../comunidade.html">Comunidade</a></li>
                <li data-page="mapa"><a href="../mapa-acessivel.html">Mapa AcessÃ­vel</a></li>
                <li data-page="about"><a href="../about.html">Sobre</a></li>
            </ul>
            <div class="mobile-navbar-actions">
                <div class="logged-out-actions-mobile">
                    <button class="btn btn-gradient" onclick="location.href='login.html'">Acessar Plataforma</button>
                </div>
                <div class="logged-in-actions-mobile hidden">
                    <div class="user-profile">
                        <img src="" alt="Foto de Perfil" class="profile-pic">
                        <span class="user-name"></span>
                    </div>
                    <button class="btn btn-outline-gradient logout-btn">Sair</button>
                </div>
            </div>
        </div>

        <section class="page-content edit-profile-page-content">
            <h2>Editar Perfil</h2>
            <p>Atualize suas informaÃ§Ãµes de perfil e senha.</p>
            <div class="profile-edit-card">
                <form id="editProfileForm" autocomplete="off">
                    <!-- Foto de Perfil -->
                    <div class="form-group" style="display: flex; flex-direction: column; align-items: center;">
                        <label for="profilePic">Foto de Perfil</label>
                        <div class="avatar-upload" style="position: relative; width: 90px; height: 90px;">
                            <img id="profilePicPreview" src="../../public/images/fotos-perfil/default-avatar.png" style="width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color); background: var(--card-background);" alt="PrÃ©via da foto de perfil">
                            <label for="profilePic" class="avatar-upload-btn" style="position: absolute; bottom: 0; right: 0; background: var(--gradient-start); color: #fff; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 8px #0002;">
                                <i class="fas fa-camera"></i>
                            </label>
                            <input type="file" id="profilePic" name="profilePic" accept="image/*" style="display:none;">
                        </div>
                    </div>
                    <!-- Dados principais -->
                    <div class="form-group">
                        <label for="userName">Nome de UsuÃ¡rio *</label>
                        <input type="text" id="userName" name="userName" required maxlength="32" placeholder="Seu nome de usuÃ¡rio">
                    </div>
                    <div class="form-group">
                        <label for="userEmail">E-mail *</label>
                        <input type="email" id="userEmail" name="userEmail" required placeholder="seu@email.com" disabled>
                    </div>
                    <div class="form-group">
                        <label for="fullName">Nome Completo *</label>
                        <input type="text" id="fullName" name="fullName" required maxlength="64" placeholder="Seu nome completo">
                    </div>
                    <div class="form-group">
                        <label for="birthdate">Data de nascimento *</label>
                        <input type="date" id="birthdate" name="birthdate" required>
                    </div>
                    <div class="form-group">
                        <label for="region">Estado e Cidade *</label>
                        <div class="uf-cidade-row" style="align-items: flex-start;">
                            <select id="ufSelect" class="uf-select" required style="width: 110px; min-width: 90px; max-width: 140px;" disabled>
                                <option value="SP" selected>SP</option>
                            </select>
                            <div style="position: relative; flex: 1;">
                                <input type="text" id="cidadeInput" class="autocomplete-cidade" placeholder="Digite sua cidade" autocomplete="off" required>
                                <div id="cidadeAutocompleteList" class="autocomplete-cidade-list" style="display:none;"></div>
                            </div>
                        </div>
                        <p style="font-size: 0.88em; color: #f44336; margin-top: 4px;">Em breve para outras regiÃµes.</p>
                        <input type="hidden" id="region" name="region" required>
                    </div>
                    <!-- Picker customizado para Tipo de Mobilidade -->
                    <div class="form-group">
                        <label for="mobilityTypePicker">Tipo de Mobilidade *</label>
                        <div class="custom-dropdown" id="mobilityTypePicker" style="position: relative;">
                            <button type="button" class="dropdown-btn" id="mobilityDropdownBtn">
                                <span id="mobilitySelected"><i class="fas fa-wheelchair"></i> Selecione</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="dropdown-list" id="mobilityDropdownList" style="display:none; position: absolute; left: 0; right: 0; width: 100%;"></div>
                            <input type="hidden" id="mobilityType" name="mobilityType" required>
                        </div>
                    </div>
                    <!-- Multi-select customizado para Comorbidades -->
                    <div class="form-group">
                        <label>Comorbidades / Necessidades Especiais</label>
                        <div class="custom-multiselect" id="comorbidadesPicker" style="position: relative;">
                            <button type="button" class="dropdown-btn" id="comorbidadesDropdownBtn">
                                <span id="comorbidadesSelected">Selecione</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="dropdown-list" id="comorbidadesDropdownList" style="display:none; max-height: 220px; overflow-y: auto; position: absolute; left: 0; right: 0; width: 100%;"></div>
                            <input type="hidden" id="comorbidades" name="comorbidades">
                            <div class="chips" id="comorbidadesChips"></div>
                        </div>
                    </div>
                    <!-- SeÃ§Ã£o Social -->
                    <hr style="margin: 32px 0 18px 0; border: none; border-top: 1.5px solid var(--border-color, #eee);">
                    <h3 style="margin-bottom: 12px; font-size: 1.13em; font-weight: 600;">Social</h3>
                    <div class="form-group">
                        <label for="userBio">Sobre Mim</label>
                        <textarea id="userBio" name="userBio" rows="4" placeholder="Fale um pouco sobre vocÃª, suas experiÃªncias e objetivos..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="userSkills">Habilidades (separadas por vÃ­rgula)</label>
                        <input type="text" id="userSkills" name="userSkills" placeholder="Ex: JavaScript, React, UX Design, Acessibilidade">
                    </div>
                    <div class="form-group">
                        <label for="userInstagram"><i class="fab fa-instagram"></i> Instagram</label>
                        <input type="text" id="userInstagram" name="userInstagram" placeholder="@seu_usuario">
                    </div>
                    <!-- SeÃ§Ã£o de AlteraÃ§Ã£o de Senha -->
                    <div class="password-section">
                        <h3>Alterar Senha</h3>
                        <p class="section-description">Preencha os campos abaixo apenas se desejar alterar sua senha.</p>
                        <div class="form-group">
                            <label for="currentPassword">Senha Atual</label>
                            <input type="password" id="currentPassword" name="currentPassword" placeholder="Sua senha atual">
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Nova Senha</label>
                            <input type="password" id="newPassword" name="newPassword" placeholder="Deixe em branco para nÃ£o alterar">
                        </div>
                        <div class="form-group">
                            <label for="confirmNewPassword">Confirmar Nova Senha</label>
                            <input type="password" id="confirmNewPassword" name="confirmNewPassword" placeholder="Confirme sua nova senha">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-gradient">Salvar AlteraÃ§Ãµes</button>
                        <button type="button" class="btn btn-outline-gradient" onclick="window.history.back();">Cancelar</button>
                    </div>
                </form>
            </div>
        </section>

    </div>

    <div id="flashNotification" class="flash-notification">
        <span id="flashNotificationMessage"></span>
        <button class="close-flash-notification-btn">&times;</button>
    </div>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-brand">
                <i class="fas fa-wheelchair"></i>
                <span>WACS</span>
                <p>Inovando na mobilidade acessÃ­vel.</p>
            </div>
            <div class="footer-links">
                <h3>Links RÃ¡pidos</h3>
                <ul>
                    <li><a href="../../index.html">Home</a></li>
                    <li><a href="../../index.html#recursos">Recursos</a></li>
                    <li><a href="../comunidade.html">Comunidade</a></li>
                    <li><a href="../mapa-acessivel.html">Mapa AcessÃ­vel</a></li>
                    <li><a href="../../index.html#contato">Contato</a></li>
                </ul>
            </div>
            <div class="footer-contact">
                <h3>Contato</h3>
                <p>Email: contato@wacs.com</p>
                <p>Telefone: (XX) XXXX-XXXX</p>
                <div class="social-icons">
                    <a href="#"><i class="fab fa-facebook-f"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-linkedin-in"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 WACS. Todos os direitos reservados.</p>
            <p class="alpha-footer-notice">Esta Ã© uma versÃ£o Alpha. Para feedback, entre em contato.</p>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="../../public/js/env-config.js"></script>
    <script src="../../public/js/auth-check.js"></script>
    <script src="../../public/js/script.js"></script>
    <div class="theme-transition-overlay"></div>
    <script>
    // Overlay para pickers
    let pickerOverlay = null;
    function showPickerOverlay() {
        if (!pickerOverlay) {
            pickerOverlay = document.createElement('div');
            pickerOverlay.className = 'picker-overlay';
            document.body.appendChild(pickerOverlay);
            pickerOverlay.onclick = function() {
                closeAllDropdowns();
            };
        }
    }
    function hidePickerOverlay() {
        if (pickerOverlay) {
            pickerOverlay.remove();
            pickerOverlay = null;
        }
    }
    function closeAllDropdowns() {
        mobilityDropdownList.style.display = 'none';
        comorbidadesDropdownList.style.display = 'none';
        hidePickerOverlay();
    }
    // Dropdown customizado para Tipo de Mobilidade
    const mobilityDropdownBtn = document.getElementById('mobilityDropdownBtn');
    const mobilityDropdownList = document.getElementById('mobilityDropdownList');
    const mobilitySelected = document.getElementById('mobilitySelected');
    const mobilityTypeInput = document.getElementById('mobilityType');

    mobilityDropdownBtn.onclick = function(e) {
        if (mobilityDropdownList.style.display === 'block') {
            mobilityDropdownList.style.display = 'none';
            hidePickerOverlay();
        } else {
            closeAllDropdowns();
            mobilityDropdownList.style.display = 'block';
            showPickerOverlay();
        }
    };
    document.addEventListener('click', function(e) {
        if (!mobilityDropdownBtn.contains(e.target) && !mobilityDropdownList.contains(e.target) && !comorbidadesDropdownBtn.contains(e.target) && !comorbidadesDropdownList.contains(e.target)) {
            closeAllDropdowns();
        }
    });
    Array.from(mobilityDropdownList.children).forEach(item => {
        item.onclick = function() {
            mobilitySelected.innerHTML = this.innerHTML;
            mobilityTypeInput.value = this.getAttribute('data-value');
            mobilityDropdownList.style.display = 'none';
            hidePickerOverlay();
        };
    });
    // Multi-select customizado para Comorbidades
    const comorbidadesDropdownBtn = document.getElementById('comorbidadesDropdownBtn');
    const comorbidadesDropdownList = document.getElementById('comorbidadesDropdownList');
    const comorbidadesSelected = document.getElementById('comorbidadesSelected');
    const comorbidadesInput = document.getElementById('comorbidades');
    const comorbidadesChips = document.getElementById('comorbidadesChips');
    let comorbidadesValues = [];
    comorbidadesDropdownBtn.onclick = function(e) {
        if (comorbidadesDropdownList.style.display === 'block') {
            comorbidadesDropdownList.style.display = 'none';
            hidePickerOverlay();
        } else {
            closeAllDropdowns();
            comorbidadesDropdownList.style.display = 'block';
            showPickerOverlay();
            updateComorbidadesDropdown();
        }
    };
    function updateComorbidadesDropdown() {
        Array.from(comorbidadesDropdownList.children).forEach(item => {
            const value = item.getAttribute('data-value');
            if (comorbidadesValues.includes(value)) {
                item.style.display = 'none';
            } else {
                item.style.display = '';
            }
        });
    }
    Array.from(comorbidadesDropdownList.children).forEach(item => {
        item.onclick = function() {
            const value = this.getAttribute('data-value');
            if (value === 'nenhuma') {
                comorbidadesValues = ['nenhuma'];
            } else {
                comorbidadesValues = comorbidadesValues.filter(v => v !== 'nenhuma');
                if (!comorbidadesValues.includes(value)) {
                    comorbidadesValues.push(value);
                }
            }
            updateComorbidadesChips();
            comorbidadesInput.value = comorbidadesValues.join(',');
            updateComorbidadesDropdown();
        };
    });
    function updateComorbidadesChips() {
        comorbidadesChips.innerHTML = '';
        if (comorbidadesValues.length === 0) {
            comorbidadesSelected.textContent = 'Selecione';
            return;
        }
        comorbidadesSelected.textContent = '';
        comorbidadesValues.forEach(val => {
            const chip = document.createElement('span');
            chip.className = 'chip';
            chip.textContent = Array.from(comorbidadesDropdownList.children).find(i => i.getAttribute('data-value') === val)?.textContent || val;
            chip.onclick = function(e) {
                comorbidadesValues = comorbidadesValues.filter(v => v !== val);
                updateComorbidadesChips();
                comorbidadesInput.value = comorbidadesValues.join(',');
                updateComorbidadesDropdown();
                e.stopPropagation();
            };
            comorbidadesChips.appendChild(chip);
        });
    }
    // Avatar upload
    const profilePicInput = document.getElementById('profilePic');
    const profilePicPreview = document.getElementById('profilePicPreview');
    profilePicInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(ev) {
                profilePicPreview.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }
    });
    // Carregar todas as cidades do Brasil via fetch
    let cidadesBrasil = [
        { uf: 'SP', nome: 'ApiaÃ­' },
        { uf: 'SP', nome: 'Barra do ChapÃ©u' },
        { uf: 'SP', nome: 'Barra do Turvo' },
        { uf: 'SP', nome: 'Cajati' },
        { uf: 'SP', nome: 'CananÃ©ia' },
        { uf: 'SP', nome: 'Eldorado' },
        { uf: 'SP', nome: 'Iguape' },
        { uf: 'SP', nome: 'Ilha Comprida' },
        { uf: 'SP', nome: 'Iporanga' },
        { uf: 'SP', nome: 'Itaoca' },
        { uf: 'SP', nome: 'ItapirapuÃ£ Paulista' },
        { uf: 'SP', nome: 'Itariri' },
        { uf: 'SP', nome: 'Jacupiranga' },
        { uf: 'SP', nome: 'JuquiÃ¡' },
        { uf: 'SP', nome: 'Juquitiba' },
        { uf: 'SP', nome: 'Miracatu' },
        { uf: 'SP', nome: 'Pariquera-AÃ§u' },
        { uf: 'SP', nome: 'Pedro de Toledo' },
        { uf: 'SP', nome: 'Registro' },
        { uf: 'SP', nome: 'Ribeira' },
        { uf: 'SP', nome: 'SÃ£o LourenÃ§o da Serra' },
        { uf: 'SP', nome: 'Sete Barras' },
        { uf: 'SP', nome: 'TapiraÃ­' }
    ];

    // Autocomplete de cidade
    const ufSelect = document.getElementById('ufSelect');
    const cidadeInput = document.getElementById('cidadeInput');
    const cidadeAutocompleteList = document.getElementById('cidadeAutocompleteList');
    const regionInput = document.getElementById('region');
    let cidadeAutocompleteIndex = -1;
    let lastCidadeValue = '';
    let cidadeInputDebounce;

    cidadeInput.addEventListener('input', function(e) {
        clearTimeout(cidadeInputDebounce);
        const val = cidadeInput.value;
        lastCidadeValue = val;
        cidadeInputDebounce = setTimeout(() => {
            autocompleteCidade(val, e);
        }, 60);
    });

    function autocompleteCidade(val, e) {
        const valLower = val.trim().toLowerCase();
        cidadeAutocompleteList.innerHTML = '';
        cidadeAutocompleteIndex = -1;

        if (!valLower) {
            cidadeAutocompleteList.style.display = 'none';
            regionInput.value = '';
            return;
        }
        // Filtrar cidades do estado selecionado (SP) e pelo texto digitado
        const matches = cidadesBrasil.filter(obj => obj.nome.toLowerCase().includes(valLower));

        if (matches.length === 0) {
            cidadeAutocompleteList.style.display = 'none';
            regionInput.value = '';
            return;
        }
        // Autocompletar inline (apenas se o usuÃ¡rio estÃ¡ digitando para frente, nÃ£o apagando)
        const firstMatch = matches[0];
        if (
            firstMatch &&
            val.length > 0 &&
            firstMatch.nome.toLowerCase().startsWith(valLower) &&
            val !== firstMatch.nome &&
            val.length > lastCidadeValue.length - 1
        ) {
            cidadeInput.value = firstMatch.nome;
            cidadeInput.setSelectionRange(val.length, firstMatch.nome.length);
            lastCidadeValue = firstMatch.nome;
        }
        matches.slice(0, 10).forEach((obj, idx) => {
            const div = document.createElement('div');
            div.className = 'autocomplete-cidade-item';
            // Destacar a parte digitada
            const idxStart = obj.nome.toLowerCase().indexOf(valLower);
            if (idxStart >= 0) {
                div.innerHTML = obj.nome.substring(0, idxStart) + '<b>' + obj.nome.substring(idxStart, idxStart + valLower.length) + '</b>' + obj.nome.substring(idxStart + valLower.length);
            } else {
                div.textContent = obj.nome;
            }
            div.onclick = function() {
                cidadeInput.value = obj.nome;
                regionInput.value = obj.uf + ' - ' + obj.nome;
                cidadeAutocompleteList.style.display = 'none';
                lastCidadeValue = obj.nome;
            };
            cidadeAutocompleteList.appendChild(div);
        });
        cidadeAutocompleteList.style.display = 'block';
    }
    cidadeInput.addEventListener('keydown', function(e) {
        const items = cidadeAutocompleteList.querySelectorAll('.autocomplete-cidade-item');
        if (!items.length) return;
        if (e.key === 'ArrowDown') {
            cidadeAutocompleteIndex = (cidadeAutocompleteIndex + 1) % items.length;
            updateCidadeAutocompleteHighlight(items);
            e.preventDefault();
        } else if (e.key === 'ArrowUp') {
            cidadeAutocompleteIndex = (cidadeAutocompleteIndex - 1 + items.length) % items.length;
            updateCidadeAutocompleteHighlight(items);
            e.preventDefault();
        } else if (e.key === 'Enter') {
            if (cidadeAutocompleteIndex >= 0 && cidadeAutocompleteIndex < items.length) {
                items[cidadeAutocompleteIndex].click();
                e.preventDefault();
            }
        }
    });
    cidadeInput.addEventListener('blur', function() {
        setTimeout(() => { cidadeAutocompleteList.style.display = 'none'; }, 120);
    });
    function updateCidadeAutocompleteHighlight(items) {
        items.forEach((item, idx) => {
            if (idx === cidadeAutocompleteIndex) {
                item.classList.add('selected');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('selected');
            }
        });
    }
    // RenderizaÃ§Ã£o dinÃ¢mica das opÃ§Ãµes dos pickers (garante que sempre aparecem)
    function renderMobilityOptions() {
        const options = [
            { value: 'cadeira', icon: 'fa-wheelchair', label: 'Cadeira de rodas' },
            { value: 'andador', icon: 'fa-walking', label: 'Andador' },
            { value: 'muleta', icon: 'fa-crutch', label: 'Muleta' },
            { value: 'visual', icon: 'fa-low-vision', label: 'DeficiÃªncia visual' },
            { value: 'auditiva', icon: 'fa-deaf', label: 'DeficiÃªncia auditiva' },
            { value: 'outra', icon: 'fa-question', label: 'Outra' },
            { value: 'nenhuma', icon: 'fa-check', label: 'Nenhuma' }
        ];
        mobilityDropdownList.innerHTML = '';
        options.forEach(opt => {
            const div = document.createElement('div');
            div.className = 'dropdown-item';
            div.setAttribute('data-value', opt.value);
            div.innerHTML = `<i class="fas ${opt.icon}"></i> ${opt.label}`;
            div.onclick = function() {
                mobilitySelected.innerHTML = this.innerHTML;
                mobilityTypeInput.value = this.getAttribute('data-value');
                mobilityDropdownList.style.display = 'none';
                hidePickerOverlay();
            };
            mobilityDropdownList.appendChild(div);
        });
    }
    function renderComorbidadesOptions() {
        const options = [
            { value: 'diabetes', label: 'Diabetes' },
            { value: 'hipertensao', label: 'HipertensÃ£o' },
            { value: 'cardio', label: 'DoenÃ§a cardiovascular' },
            { value: 'respiratorio', label: 'Problemas respiratÃ³rios' },
            { value: 'outra', label: 'Outro' },
            { value: 'nenhuma', label: 'Nenhuma' }
        ];
        comorbidadesDropdownList.innerHTML = '';
        options.forEach(opt => {
            const div = document.createElement('div');
            div.className = 'dropdown-item';
            div.setAttribute('data-value', opt.value);
            div.textContent = opt.label;
            div.onclick = function() {
                const value = this.getAttribute('data-value');
                if (value === 'nenhuma') {
                    comorbidadesValues = ['nenhuma'];
                } else {
                    comorbidadesValues = comorbidadesValues.filter(v => v !== 'nenhuma');
                    if (!comorbidadesValues.includes(value)) {
                        comorbidadesValues.push(value);
                    }
                }
                updateComorbidadesChips();
                comorbidadesInput.value = comorbidadesValues.join(',');
                updateComorbidadesDropdown();
            };
            comorbidadesDropdownList.appendChild(div);
        });
    }
    renderMobilityOptions();
    renderComorbidadesOptions();

    // Preencher formulÃ¡rio de ediÃ§Ã£o de perfil com dados do Firebase
    // Requer que auth-check.js jÃ¡ tenha inicializado o Firebase

    document.addEventListener('DOMContentLoaded', function() {
        // ReferÃªncias dos campos do formulÃ¡rio
        const profilePicPreview = document.getElementById('profilePicPreview');
        const userNameInput = document.getElementById('userName');
        const userEmailInput = document.getElementById('userEmail');
        const fullNameInput = document.getElementById('fullName');
        const birthdateInput = document.getElementById('birthdate');
        const ufSelect = document.getElementById('ufSelect');
        const cidadeInput = document.getElementById('cidadeInput');
        const regionInput = document.getElementById('region');
        const mobilityTypeInput = document.getElementById('mobilityType');
        const mobilitySelected = document.getElementById('mobilitySelected');
        const comorbidadesInput = document.getElementById('comorbidades');
        const comorbidadesChips = document.getElementById('comorbidadesChips');
        const userBioInput = document.getElementById('userBio');
        const userSkillsInput = document.getElementById('userSkills');
        const userInstagramInput = document.getElementById('userInstagram');

        // Helper para preencher chips de comorbidades
        function setComorbidades(values) {
            comorbidadesInput.value = Array.isArray(values) ? values.join(',') : (values || '');
            comorbidadesChips.innerHTML = '';
            (Array.isArray(values) ? values : (values ? [values] : [])).forEach(val => {
                const chip = document.createElement('div');
                chip.className = 'chip';
                chip.textContent = val;
                comorbidadesChips.appendChild(chip);
            });
        }

        // Listener de autenticaÃ§Ã£o
        auth.onAuthStateChanged(async function(user) {
            if (!user) {
                // NÃ£o autenticado, redireciona para login
                window.location.href = 'login.html';
                return;
            }
            // Preenche dados do Auth
            userNameInput.value = user.displayName || '';
            userEmailInput.value = user.email || '';
            if (user.photoURL) {
                profilePicPreview.src = user.photoURL;
            }
            // Busca dados adicionais do Firestore
            try {
                            // Buscar documento do usuÃ¡rio usando funÃ§Ã£o utilitÃ¡ria
            const userDoc = await window.getUserDocument(user.uid);
            if (userDoc) {
                const data = userDoc.data();
                    if (data.fullName) fullNameInput.value = data.fullName;
                    if (data.birthdate) birthdateInput.value = data.birthdate;
                    if (data.uf) ufSelect.value = data.uf;
                    if (data.cidade) cidadeInput.value = data.cidade;
                    if (data.region) regionInput.value = data.region;
                    if (data.mobilityType) {
                        mobilityTypeInput.value = data.mobilityType;
                        // Atualiza texto do picker customizado
                        if (mobilitySelected) mobilitySelected.innerHTML = data.mobilityType;
                    }
                    if (data.comorbidades) setComorbidades(Array.isArray(data.comorbidades) ? data.comorbidades : (typeof data.comorbidades === 'string' ? data.comorbidades.split(',') : []));
                    if (data.bio) userBioInput.value = data.bio;
                    if (data.skills) userSkillsInput.value = data.skills;
                    if (data.instagram) userInstagramInput.value = data.instagram;
                }
            } catch (e) {
                console.error('Erro ao buscar dados do Firestore:', e);
            }
        });
    });

    // Atualizar dados do usuÃ¡rio ao submeter o formulÃ¡rio
    const editProfileForm = document.getElementById('editProfileForm');
    editProfileForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!auth.currentUser) {
            showFlashMessage('UsuÃ¡rio nÃ£o autenticado.', 'error');
            return;
        }
        const user = auth.currentUser;
        // Coletar dados do formulÃ¡rio
        const displayName = document.getElementById('userName').value.trim();
        const fullName = document.getElementById('fullName').value.trim();
        const birthdate = document.getElementById('birthdate').value;
        const uf = document.getElementById('ufSelect').value;
        const cidade = document.getElementById('cidadeInput').value.trim();
        const region = document.getElementById('region').value;
        const mobilityType = document.getElementById('mobilityType').value;
        const comorbidades = document.getElementById('comorbidades').value.split(',').map(s => s.trim()).filter(Boolean);
        const bio = document.getElementById('userBio').value;
        const skills = document.getElementById('userSkills').value;
        const instagram = document.getElementById('userInstagram').value;
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;
        const profilePicInput = document.getElementById('profilePic');
        let photoURL = user.photoURL;

        // ValidaÃ§Ã£o bÃ¡sica
        if (!displayName || !fullName || !birthdate || !uf || !cidade || !region || !mobilityType) {
            showFlashMessage('Preencha todos os campos obrigatÃ³rios.', 'error');
            return;
        }
        if ((newPassword || confirmNewPassword) && newPassword !== confirmNewPassword) {
            showFlashMessage('As senhas nÃ£o coincidem.', 'error');
            return;
        }
        if (newPassword && newPassword.length < 6) {
            showFlashMessage('A nova senha deve ter pelo menos 6 caracteres.', 'error');
            return;
        }

        try {
            // Atualizar foto de perfil se alterada
            if (profilePicInput.files && profilePicInput.files[0]) {
                const file = profilePicInput.files[0];
                const storageRef = firebase.storage().ref();
                const fileName = `${user.uid}_profile_${Date.now()}`;
                const fileRef = storageRef.child(`profile_pictures/${fileName}`);
                await fileRef.put(file);
                photoURL = await fileRef.getDownloadURL();
                await user.updateProfile({ photoURL });
            }
            // Atualizar displayName
            if (user.displayName !== displayName) {
                await user.updateProfile({ displayName });
            }
            // Atualizar senha se necessÃ¡rio
            if (newPassword) {
                if (!currentPassword) {
                    showFlashMessage('Informe a senha atual para alterar a senha.', 'error');
                    return;
                }
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                await user.reauthenticateWithCredential(credential);
                await user.updatePassword(newPassword);
            }
            // Atualizar dados no Firestore usando o username (ID do documento)
            const userData = {
                uid: user.uid, // Manter o UID do Firebase Auth para referÃªncia
                displayName,
                fullName,
                birthdate,
                uf,
                cidade,
                region,
                mobilityType,
                comorbidades,
                bio,
                skills,
                instagram,
                photoURL,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // manter o mesmo ID do documento (username). Caso o doc seja do modelo antigo, caia para displayName
            const existingDoc = await window.getUserDocument(user.uid);
            const docId = existingDoc ? existingDoc.id : (displayName || fullName);
            await window.saveUserDocument(docId, userData);
            showFlashMessage('Perfil atualizado com sucesso!', 'success');
            // Limpar campos de senha
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        } catch (error) {
            console.error(error);
            showFlashMessage('Erro ao atualizar perfil: ' + (error.message || error), 'error');
        }
    });
    </script>
</body>
</html> 