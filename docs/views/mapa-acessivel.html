<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WACS - Mapa Acess√≠vel</title>
    <link rel="stylesheet" href="../public/css/main.css">
    <link rel="stylesheet" href="../public/css/navbar.css">
    <link rel="stylesheet" href="../public/css/footer.css">
    <link rel="stylesheet" href="../public/css/transitions.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        .locations-container {
            max-width: 100%;
            margin: 20px auto;
            padding: 20px;
            overflow-x: hidden;
        }

        .filters-section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 500;
            color: var(--text-color);
        }

        .filter-group select,
        .filter-group input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-color);
        }

        .search-bar {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 15px;
            background: var(--input-bg);
            color: var(--text-color);
        }

        #locationsList {
            display: flex;
            gap: 20px;
            padding: 20px 0;
            overflow-x: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) var(--card-bg);
            justify-content: center;
        }

        #locationsList::-webkit-scrollbar {
            height: 8px;
        }

        #locationsList::-webkit-scrollbar-track {
            background: var(--card-bg);
            border-radius: 4px;
        }

        #locationsList::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 4px;
        }

        .location-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            min-width: 300px;
            max-width: 300px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            flex: 0 0 auto;
        }

        .location-card:hover {
            transform: translateY(-2px);
        }

        .location-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .location-name {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-color);
        }

        .location-rating {
            color: #ffd700;
        }

        .location-details {
            color: var(--text-color);
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .accessibility-features {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .feature-tag {
            background: var(--accent-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
        }

        .scroll-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .scroll-button {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .scroll-button:hover {
            background: var(--accent-color-dark);
        }

        .map-container {
            width: 100%;
            max-width: 1200px;
            height: 400px;
            margin: 0 auto 32px auto;
            border-radius: 12px;
            overflow: hidden;
            background: #222; /* fallback para dark */
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .star:hover {
            color: #ffd700;
        }
        .feature-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }
        .feature-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        .evaluation-card {
            transition: all 0.3s ease;
        }
        .evaluation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Estilos para o modal de avalia√ß√£o */
        .modal {
            animation: fadeIn 0.3s ease-in-out;
        }

        .modal-content {
            animation: slideIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-50px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .rating-stars .star.active {
            color: #ffd700 !important;
        }

        .rating-stars .star:hover {
            color: #ffd700 !important;
        }

        /* Estilos para os bot√µes do modal */
        .btn-outline-gradient {
            background: transparent;
            border: 2px solid var(--accent-color, #4A90E2);
            color: var(--accent-color, #4A90E2);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-outline-gradient:hover {
            background: var(--accent-color, #4A90E2);
            color: white;
        }

        /* Responsividade do modal */
        @media (max-width: 768px) {
            .modal-content {
                margin: 10% auto;
                max-width: 95%;
                padding: 20px;
            }
        }

        /* Estilos para campos somente leitura */
        input[readonly] {
            background-color: var(--card-bg, #f5f5f5) !important;
            color: var(--text-color) !important;
            cursor: not-allowed !important;
            border-color: var(--border-color) !important;
            opacity: 0.8;
        }

        body.dark-theme input[readonly] {
            background-color: var(--dark-card, #2d3748) !important;
            color: var(--dark-text, #e2e8f0) !important;
        }

        /* Indicador visual para campo somente leitura */
        .readonly-indicator {
            position: relative;
        }

        .readonly-indicator::after {
            content: "üîí";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            opacity: 0.6;
        }

        .eval-dark-modal {
            background: #181c27 !important;
            color: #fff !important;
        }
        .eval-local-box {
            background: #22304a;
            border-radius: 8px;
            padding: 16px 18px 10px 18px;
            margin-bottom: 18px;
        }
        .eval-feature-row {
            display: flex;
            align-items: center;
            background: #20283a;
            border-radius: 6px;
            margin-bottom: 10px;
            padding: 8px 12px;
            gap: 12px;
        }
        .eval-feature-icon {
            color: #4A90E2;
            font-size: 1.3rem;
            width: 32px;
            text-align: center;
        }
        .eval-feature-label {
            flex: 1;
            font-size: 1.08rem;
            color: #c9d6f3;
            font-weight: 500;
        }
        .eval-feature-stars {
            min-width: 120px;
            text-align: right;
        }
        .eval-feature-stars .star {
            font-size: 1.25rem;
            color: #3a4662;
            cursor: pointer;
            transition: color 0.2s;
            margin-left: 2px;
        }
        .eval-feature-stars .star.active {
            color: #ffd700;
        }
        .eval-feature-stars .star:hover,
        .eval-feature-stars .star.hovered {
            color: #ffe066;
        }
        .eval-btn-enviar {
            width: 100%;
            background: #4A90E2;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 13px 0;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.2s;
        }
        .eval-btn-enviar:hover {
            background: #3576b8;
        }
    </style>
</head>
<body class="fade-in">
    <div class="main-container">
        <nav class="navbar">
            <button class="menu-toggle-btn">
                <i class="fas fa-bars"></i>
            </button>
            <div class="navbar-logo">
                <i class="fas fa-wheelchair"></i>
                <span>WACS</span>
            </div>
            <ul class="navbar-menu">
                <li data-page="home"><a href="../index.html">Home</a></li>
                <li data-page="recursos"><a href="recursos.html">Recursos</a></li>
                <li data-page="comunidade"><a href="comunidade.html">Comunidade</a></li>
                <li data-page="mapa"><a href="mapa-acessivel.html">Mapa Acess√≠vel</a></li>
                <li data-page="about"><a href="about.html">Sobre</a></li>
            </ul>
            <div class="navbar-actions">
                <button class="theme-toggle-btn">
                    <i class="fas fa-sun"></i>
                </button>
                <div class="mobile-user-status">
                    <img src="" alt="Foto de Perfil" class="profile-pic-mobile hidden">
                    <button class="btn btn-outline-gradient login-btn-mobile hidden" onclick="location.href='user/login.html'">Login</button>
                </div>
                <div class="logged-out-actions">
                    <button class="btn btn-gradient" onclick="location.href='user/login.html'">Acessar Plataforma</button>
                </div>
                <div class="logged-in-actions hidden">
                    <div class="user-profile">
                        <img src="" alt="Foto de Perfil" class="profile-pic">
                        <span class="user-name"></span>
                    </div>
                    <button class="btn btn-outline-gradient logout-btn">Sair</button>
                </div>
            </div>
        </nav>

        <div class="mobile-menu-overlay">
            <div class="mobile-menu-header">
                <div class="navbar-logo">
                    <i class="fas fa-wheelchair"></i>
                    <span>WACS</span>
                </div>
                <button class="close-menu-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <ul class="mobile-navbar-menu">
                <li data-page="home"><a href="../index.html">Home</a></li>
                <li data-page="recursos"><a href="recursos.html">Recursos</a></li>
                <li data-page="comunidade"><a href="comunidade.html">Comunidade</a></li>
                <li data-page="mapa"><a href="mapa-acessivel.html">Mapa Acess√≠vel</a></li>
                <li data-page="about"><a href="about.html">Sobre</a></li>
            </ul>
            <div class="mobile-navbar-actions">
                <div class="logged-out-actions-mobile">
                    <button class="btn btn-gradient" onclick="location.href='user/login.html'">Acessar Plataforma</button>
                </div>
                <div class="logged-in-actions-mobile hidden">
                    <div class="user-profile">
                        <img src="" alt="Foto de Perfil" class="profile-pic">
                        <span class="user-name"></span>
                    </div>
                    <button class="btn btn-outline-gradient logout-btn">Sair</button>
                </div>
            </div>
        </div>

        <section class="page-content">
            <h1 style="text-align: center;">Mapa Acess√≠vel</h1>
            <p style="text-align: center;">Encontre locais acess√≠veis pr√≥ximos a voc√™ e compartilhe suas experi√™ncias!</p>
            
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn btn-gradient" id="addLocationBtn">Adicionar Novo Local Acess√≠vel</button>
                <button class="btn btn-outline-gradient" id="evaluateLocationBtn" style="margin-left: 10px;">Avaliar Local</button>
            </div>

            <div class="locations-container">
                <div class="filters-section">
                    <input type="text" class="search-bar" placeholder="Buscar locais..." id="searchInput">
                    
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label for="typeFilter">Tipo de Local</label>
                            <select id="typeFilter">
                                <option value="">Todos</option>
                                <option value="shopping">Shopping</option>
                                <option value="restaurante">Restaurante</option>
                                <option value="parque">Parque</option>
                                <option value="teatro">Teatro</option>
                                <option value="museu">Museu</option>
                                <option value="hotel">Hotel</option>
                                <option value="escola">Escola</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="ratingFilter">Avalia√ß√£o M√≠nima</label>
                            <select id="ratingFilter">
                                <option value="0">Todas</option>
                                <option value="3">3+ estrelas</option>
                                <option value="4">4+ estrelas</option>
                                <option value="4.5">4.5+ estrelas</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="featureFilter">Recurso de Acessibilidade</label>
                            <select id="featureFilter">
                                <option value="">Todos</option>
                                <option value="rampa">Rampas</option>
                                <option value="elevador">Elevadores</option>
                                <option value="braile">Braile</option>
                                <option value="libras">Libras</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="locationsList">
                    <!-- Cards de locais ser√£o inseridos aqui dinamicamente -->
                </div>
                <div class="scroll-buttons">
                    <button class="scroll-button" id="prevPageBtn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="scroll-button" id="nextPageBtn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div style="margin-top: 48px; margin-bottom: 16px; text-align: center;">
                    <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 8px; letter-spacing: -1px;">Mapa de Locais Acess√≠veis</h2>
                    <p style="color: var(--text-secondary, #aaa); font-size: 1.05rem;">Veja no mapa os locais cadastrados pela comunidade</p>
                </div>
                <div class="map-container">
                    <p>O mapa ser√° carregado aqui</p>
                </div>
            </div>
        </section>

    </div>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-brand">
                <i class="fas fa-wheelchair"></i>
                <span>WACS</span>
                <p>Inovando na mobilidade acess√≠vel.</p>
            </div>
            <div class="footer-links">
                <h3>Links R√°pidos</h3>
                <ul>
                    <li><a href="../index.html#home">Home</a></li>
                    <li><a href="recursos.html">Recursos</a></li>
                    <li><a href="comunidade.html">Comunidade</a></li>
                    <li><a href="mapa-acessivel.html">Mapa Acess√≠vel</a></li>
                </ul>
            </div>
            <div class="footer-contact">
                <h3>Contato</h3>
                <p>Email: contato@wacs.com</p>
                <p>Telefone: (XX) XXXX-XXXX</p>
                <div class="social-icons">
                    <a href="#"><i class="fab fa-facebook-f"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-linkedin-in"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 WACS. Todos os direitos reservados.</p>
            <p class="alpha-footer-notice">Esta √© uma vers√£o Alpha. Para feedback, entre em contato.</p>
        </div>
    </footer>

    <!-- Modal para Adicionar Local -->
    <div id="addLocationModal" class="modal" style="display:none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
        <div class="modal-content" style="background-color: #111; color: #fff; opacity: 1; margin: 10% auto; padding: 25px; border-radius: 8px; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Adicionar Novo Local</h2>
                <span class="close-btn" id="closeModalBtn" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
            </div>
            <form id="addLocationForm">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="locationName" style="display: block; margin-bottom: 5px;">Nome do Local</label>
                    <input type="text" id="locationName" name="locationName" class="form-control" required style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color);">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="locationMap" style="display: block; margin-bottom: 5px;">Selecione no mapa</label>
                    <div id="locationMap" style="width: 100%; height: 220px; border-radius: 8px; margin-bottom: 10px;"></div>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="locationAddress" style="display: block; margin-bottom: 5px;">Endere√ßo Completo</label>
                    <input type="text" id="locationAddress" name="locationAddress" class="form-control" required placeholder="Ex: Av. Paulista, 1000, S√£o Paulo, SP" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color);">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="locationType" style="display: block; margin-bottom: 5px;">Tipo de Local</label>
                    <select id="locationType" name="locationType" class="form-control" required style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color);">
                        <option value="shopping">Shopping</option>
                        <option value="restaurante">Restaurante</option>
                        <option value="parque">Parque</option>
                        <option value="teatro">Teatro</option>
                        <option value="museu">Museu</option>
                        <option value="hotel">Hotel</option>
                        <option value="escola">Escola</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Recursos de Acessibilidade</label>
                    <div id="featuresCheckboxes" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div><input type="checkbox" id="featureRampa" value="Rampas"><label for="featureRampa" style="margin-left: 5px;">Rampas</label></div>
                        <div><input type="checkbox" id="featureElevador" value="Elevadores"><label for="featureElevador" style="margin-left: 5px;">Elevadores</label></div>
                        <div><input type="checkbox" id="featureBraile" value="Sinaliza√ß√£o em Braile"><label for="featureBraile" style="margin-left: 5px;">Sinaliza√ß√£o em Braile</label></div>
                        <div><input type="checkbox" id="featureLibras" value="Atendimento em Libras"><label for="featureLibras" style="margin-left: 5px;">Atendimento em Libras</label></div>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="locationImage" style="display: block; margin-bottom: 5px;">Foto do Local</label>
                    <input type="file" id="locationImage" name="locationImage" accept="image/*" style="width: 100%; color: var(--text-color);">
                </div>
                <div style="text-align: right;">
                    <button type="submit" class="btn btn-gradient">Salvar Local</button>
                </div>
                 <div id="formStatus" style="margin-top: 15px; text-align: center;"></div>
            </form>
        </div>
    </div>

    <!-- Modal para Avalia√ß√£o de Local -->
    <div id="evaluationModal" class="modal" style="display:none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
        <div class="modal-content eval-dark-modal" style="background-color: #181c27; color: #fff; opacity: 1; margin: 5% auto; padding: 32px 32px 24px 32px; border-radius: 12px; max-width: 540px; max-height: 95vh; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="margin: 0; color: #4A90E2; font-size: 1.6rem; font-weight: 700;">Avaliar Local</h2>
                <span class="close-btn" id="closeEvaluationModalBtn" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
            </div>
            <div class="eval-local-box" style="background: #22304a; border-radius: 8px; padding: 16px 18px 10px 18px; margin-bottom: 18px;">
                <label for="evalLocalName" style="display:none"></label>
                <input type="text" id="evalLocalName" placeholder="Digite o nome do local" autocomplete="off" style="width:100%;margin-bottom:10px;padding:8px;border-radius:4px;border:1px solid var(--border-color);background:var(--input-bg);color:var(--text-color);display:none;">
                <div id="evalLocalNameSuggestions" style="position:relative;"></div>
                <div id="evalLocalNameReadonly" style="width:100%;margin-bottom:10px;padding:8px;border-radius:4px;background:var(--input-bg);color:var(--text-color);font-weight:600;display:none;"></div>
                <div id="evalLocalAddress" style="font-size: 0.98rem; color: #c9d6f3; word-break: break-word;"></div>
            </div>
            <form id="evaluationForm">
                <div style="margin-bottom: 18px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #fff;">Avalia√ß√£o dos Recursos de Acessibilidade</div>
                    <div class="eval-feature-row">
                        <span class="eval-feature-icon"><i class="fas fa-wheelchair"></i></span>
                        <span class="eval-feature-label">Cadeira de Rodas</span>
                        <span class="eval-feature-stars" data-feature="cadeira_rodas"></span>
                    </div>
                    <div class="eval-feature-row">
                        <span class="eval-feature-icon"><i class="fas fa-ruler-combined"></i></span>
                        <span class="eval-feature-label">Rampa</span>
                        <span class="eval-feature-stars" data-feature="rampa"></span>
                    </div>
                    <div class="eval-feature-row">
                        <span class="eval-feature-icon"><i class="fas fa-elevator"></i></span>
                        <span class="eval-feature-label">Elevador</span>
                        <span class="eval-feature-stars" data-feature="elevador"></span>
                    </div>
                    <div class="eval-feature-row">
                        <span class="eval-feature-icon"><i class="fas fa-restroom"></i></span>
                        <span class="eval-feature-label">Banheiro Adaptado</span>
                        <span class="eval-feature-stars" data-feature="banheiro"></span>
                    </div>
                </div>
                <div style="margin-bottom: 18px;">
                    <label for="evalComments" style="font-weight: 500; color: #c9d6f3; margin-bottom: 6px; display: block;">Coment√°rio (opcional)</label>
                    <textarea id="evalComments" name="comments" rows="4" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #2a3550; background: #1a2130; color: #fff; resize: vertical;"></textarea>
                </div>
                <div id="evaluationFormStatus" style="margin-bottom: 10px; text-align: center;"></div>
                <div style="margin-top:10px; text-align:center; display: flex; justify-content: center; gap: 12px;">
                    <button type="submit" class="eval-btn-enviar">Enviar Avalia√ß√£o</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para ver todas avalia√ß√µes de um local -->
    <div id="allReviewsModal" class="modal" style="display:none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);">
        <div class="modal-content" style="background-color: #181c27; color: #fff; opacity: 1; margin: 5% auto; padding: 32px 32px 24px 32px; border-radius: 12px; max-width: 540px; max-height: 95vh; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 id="allReviewsModalTitle" style="margin: 0; color: #4A90E2; font-size: 1.3rem; font-weight: 700;">Avalia√ß√µes do Local</h2>
                <span class="close-btn" id="closeAllReviewsModalBtn" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
            </div>
            <div id="allReviewsModalContent">
                <p style="text-align:center;">Carregando avalia√ß√µes...</p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    <script src="../public/js/env-config.js"></script>
    <script src="../public/js/auth-check.js"></script>
    <script src="../public/js/script.js"></script>
    <div class="theme-transition-overlay"></div>

    <script>
        // --- Vari√°veis Globais ---
        const searchInput = document.getElementById('searchInput');
        const typeFilter = document.getElementById('typeFilter');
        const ratingFilter = document.getElementById('ratingFilter');
        const featureFilter = document.getElementById('featureFilter');
        const locationsList = document.getElementById('locationsList');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        
        let allLocationsData = []; // Armazena todos os locais do Firebase
        let filteredLocationsData = []; // Armazena os locais filtrados
        
        // --- Vari√°veis de Pagina√ß√£o ---
        let currentPage = 0;
        const cardsPerPage = 3;
        
        // --- Fun√ß√µes de Renderiza√ß√£o e UI ---

        /**
         * Gera o HTML para as estrelas de avalia√ß√£o.
         */
        function getRatingStars(rating) {
            let stars = '';
            const floorRating = Math.floor(rating);
            for (let i = 1; i <= 5; i++) {
                if (i <= floorRating) {
                    stars += '<i class="fas fa-star"></i>';
                } else if (i === Math.ceil(rating) && rating % 1 !== 0) {
                    stars += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    stars += '<i class="far fa-star"></i>';
                }
            }
            return stars;
        }

        /**
         * Renderiza os cards de locais na lista com base na pagina√ß√£o.
         */
        function renderLocationCards(locations, page = 0) {
            locationsList.innerHTML = ''; // Limpa a lista atual
            currentPage = page;

            if (locations.length === 0) {
                locationsList.innerHTML = '<p style="text-align: center; width: 100%;">Nenhum local encontrado com os filtros selecionados.</p>';
                updatePaginationControls(0);
                return;
            }

            const startIndex = page * cardsPerPage;
            const endIndex = startIndex + cardsPerPage;
            const paginatedLocations = locations.slice(startIndex, endIndex);

            // Fun√ß√£o auxiliar para buscar imagem do local se n√£o houver
            async function getLocationImageUrl(data) {
                let imageUrl = data.imageUrl || data.image || data.photoUrl || '';
                if (!imageUrl && data.id) {
                    try {
                        const doc = await firebase.firestore().collection('accessibleLocations').doc(data.id).get();
                        if (doc.exists) {
                            const docData = doc.data();
                            imageUrl = docData.imageUrl || docData.image || docData.photoUrl || '';
                        }
                    } catch (e) { /* ignora erro */ }
                }
                if (!imageUrl) {
                    imageUrl = '../public/images/logos-wacs/logo_padrao.png'; // imagem padr√£o
                }
                return imageUrl;
            }

            // Renderiza√ß√£o ass√≠ncrona dos cards
            (async () => {
                for (const data of paginatedLocations) {
                    const card = document.createElement('div');
                    card.className = 'location-card';
                    card.dataset.type = data.type || 'geral';
                    card.dataset.rating = data.rating || 0;
                    card.dataset.features = (data.features || []).join(',');

                    const rating = data.rating || 0;
                    const imageUrl = await getLocationImageUrl(data);

                    // Monta o HTML do card
                    card.innerHTML = `
                        ${imageUrl ? `<img src="${imageUrl}" alt="Foto de ${data.name}" style="width: calc(100% + 40px); margin: -20px -20px 15px -20px; border-radius: 8px 8px 0 0; height: 140px; object-fit: cover;" onerror="this.style.display='none'">` : ''}
                        <div class="location-header">
                            <span class="location-name">${data.name}</span>
                            <span class="location-rating">
                                ${getRatingStars(rating)}
                                <span style="font-size: 0.9em; margin-left: 4px;">${rating.toFixed(1)}</span>
                            </span>
                        </div>
                        <div class="location-details">
                            <p><i class="fas fa-map-marker-alt"></i> ${data.address || 'Endere√ßo n√£o informado'}</p>
                            ${(data.recentReviews && data.recentReviews.length > 0) ? data.recentReviews.map(r => `
                                <div style='margin-bottom:8px;'>
                                    <span style='color:#ffd700;'>${getRatingStars(r.rating)}</span>
                                    <b style='margin-left:6px;'>${r.rating.toFixed(1)}</b>
                                    ${r.userName ? `<span style='margin-left:8px;font-size:0.9em;color:#888;'>por ${r.userName}</span>` : ''}
                                    ${r.createdAt ? `<span style='margin-left:8px;font-size:0.85em;color:#aaa;'>${(new Date(r.createdAt)).toLocaleDateString('pt-BR')}</span>` : ''}
                                    ${r.comment ? `<div style='font-size:0.97em;margin-top:2px;'><i class='fas fa-comment'></i> "${r.comment}"</div>` : ''}
                                </div>
                            `).join('') : ''}
                            <div style="margin-top:10px; text-align:center; display: flex; justify-content: center; gap: 12px;">
                                <button class="btn btn-outline-gradient" onclick="showAllReviewsModal('${data.name.replace(/'/g, "\\'")}')" style="font-size:0.92em; padding:6px 14px; margin-top:4px;">
                                    <i class="fas fa-list"></i> Ver todas avalia√ß√µes
                                </button>
                                <button class="btn btn-outline-gradient" onclick="evaluateLocation('${data.name}', '${data.address}')" style="font-size: 0.9em; padding: 8px 16px;">
                                    <i class="fas fa-star"></i> Avaliar Local
                                </button>
                            </div>
                        </div>
                        <div class="accessibility-features">
                            ${(data.features || []).map(f => {
                                let icon = '';
                                switch (f.toLowerCase()) {
                                    case 'rampas':
                                    case 'rampa':
                                        icon = '<i class="fas fa-ruler-combined"></i>';
                                        break;
                                    case 'elevadores':
                                    case 'elevador':
                                        icon = '<i class="fas fa-elevator"></i>';
                                        break;
                                    case 'banheiro adaptado':
                                    case 'banheiro':
                                        icon = '<i class="fas fa-restroom"></i>';
                                        break;
                                    case 'sinaliza√ß√£o em braile':
                                    case 'braile':
                                        icon = '<i class="fas fa-braille"></i>';
                                        break;
                                    case 'atendimento em libras':
                                    case 'libras':
                                        icon = '<i class="fas fa-sign-language"></i>';
                                        break;
                                    case 'cadeira de rodas':
                                        icon = '<i class="fas fa-wheelchair"></i>';
                                        break;
                                    default:
                                        icon = '<i class="fas fa-universal-access"></i>';
                                }
                                return `<span class='feature-tag'>${icon} ${f}</span>`;
                            }).join('')}
                        </div>
                        ${data.lastUser ? `
                        <div class="user-info">
                            <div class="user-avatar">${data.lastUser.initials || '...'}</div>
                            <span>${data.lastUser.name} - ${data.lastUser.timestamp}</span>
                        </div>` : ''}
                    `;
                    locationsList.appendChild(card);
                }
                updatePaginationControls(locations.length);
            })();
        }

        /**
         * Atualiza o estado e a visibilidade dos bot√µes de pagina√ß√£o.
         */
        function updatePaginationControls(totalItems) {
            const totalPages = Math.ceil(totalItems / cardsPerPage);
            const scrollButtonsContainer = document.querySelector('.scroll-buttons');

            prevPageBtn.disabled = currentPage === 0;
            nextPageBtn.disabled = currentPage >= totalPages - 1;

            if (totalPages > 1) {
                scrollButtonsContainer.style.display = 'flex';
            } else {
                scrollButtonsContainer.style.display = 'none';
            }
        }
        
        // --- L√≥gica de Filtro ---

        function filterAndRender() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedType = typeFilter.value;
            const minRating = parseFloat(ratingFilter.value);
            const selectedFeature = featureFilter.value;

            filteredLocationsData = allLocationsData.filter(data => {
                const name = (data.name || '').toLowerCase();
                const type = data.type || 'geral';
                const rating = data.rating || 0;
                const features = data.features || [];

                const matchesSearch = name.includes(searchTerm);
                const matchesType = !selectedType || type === selectedType;
                const matchesRating = rating >= minRating;
                const matchesFeature = !selectedFeature || features.includes(selectedFeature);

                return matchesSearch && matchesType && matchesRating && matchesFeature;
            });

            // Ordenar por m√©dia de avalia√ß√£o (do maior para o menor)
            filteredLocationsData.sort((a, b) => {
                const ratingA = a.rating || 0;
                const ratingB = b.rating || 0;
                
                // Se as avalia√ß√µes s√£o iguais, ordenar por quantidade de avalia√ß√µes (mais avalia√ß√µes primeiro)
                if (ratingA === ratingB) {
                    const reviewCountA = a.reviewCount || 0;
                    const reviewCountB = b.reviewCount || 0;
                    return reviewCountB - reviewCountA;
                }
                
                // Ordenar por avalia√ß√£o (maior primeiro)
                return ratingB - ratingA;
            });
            
            renderLocationCards(filteredLocationsData, 0); // Renderiza a primeira p√°gina dos resultados
            loadMarkersForAccessibleMap(filteredLocationsData); // Atualiza todos os marcadores no mapa
        }

        searchInput.addEventListener('input', filterAndRender);
        typeFilter.addEventListener('change', filterAndRender);
        ratingFilter.addEventListener('change', filterAndRender);
        featureFilter.addEventListener('change', filterAndRender);

        // --- Event Listeners para Pagina√ß√£o ---
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 0) {
                renderLocationCards(filteredLocationsData, currentPage - 1);
            }
        });

        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredLocationsData.length / cardsPerPage);
            if (currentPage < totalPages - 1) {
                renderLocationCards(filteredLocationsData, currentPage + 1);
            }
        });

        // --- L√≥gica do Modal ---
        const modal = document.getElementById('addLocationModal');
        const addLocationBtn = document.getElementById('addLocationBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const addLocationForm = document.getElementById('addLocationForm');
        const formStatus = document.getElementById('formStatus');
        
        let selectedCoordinates = null;
        let mapInstance = null;
        let markerInstance = null;
        let geocoderInstance = null;

        function initLocationPickerMap() {
            const mapDiv = document.getElementById('locationMap');
            if (!mapDiv || typeof google === 'undefined' || !google.maps) return;
            if (!geocoderInstance) geocoderInstance = new google.maps.Geocoder();
            mapInstance = new google.maps.Map(mapDiv, {
                center: { lat: -23.55052, lng: -46.633308 }, // Centro de SP
                zoom: 12,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                streetViewControl: false,
                fullscreenControl: false
            });
            mapInstance.addListener('click', function(event) {
                const latLng = event.latLng;
                if (markerInstance) markerInstance.setMap(null);
                markerInstance = new google.maps.Marker({
                    position: latLng,
                    map: mapInstance
                });
                selectedCoordinates = {
                    latitude: latLng.lat(),
                    longitude: latLng.lng()
                };
                // Geocodifica√ß√£o reversa para preencher o endere√ßo
                geocoderInstance.geocode({ location: latLng }, function(results, status) {
                    if (status === 'OK' && results[0]) {
                        document.getElementById('locationAddress').value = results[0].formatted_address;
                    }
                });
            });
        }

        addLocationBtn.addEventListener('click', function(e) {
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                e.preventDefault();
                window.location.href = 'user/login.html';
            } else {
                modal.style.display = 'block';
                setTimeout(initLocationPickerMap, 300); // Aguarda o modal abrir
            }
        });

        closeModalBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });

        addLocationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            formStatus.textContent = 'Salvando, por favor aguarde...';
            formStatus.style.color = 'var(--accent-color)';

            const locationName = document.getElementById('locationName').value;
            const locationAddress = document.getElementById('locationAddress').value;
            const locationType = document.getElementById('locationType').value;
            const imageFile = document.getElementById('locationImage').files[0];
            const selectedFeatures = Array.from(document.querySelectorAll('#featuresCheckboxes input:checked')).map(cb => cb.value);

            // Valida√ß√£o extra: endere√ßo e coordenadas
            if (!locationAddress || locationAddress.length < 5) {
                formStatus.textContent = 'Por favor, selecione um endere√ßo v√°lido no mapa ou digite um endere√ßo completo.';
                formStatus.style.color = 'red';
                return;
            }

            let coordinates = null;
            if (selectedCoordinates) {
                coordinates = selectedCoordinates;
            } else {
                // fallback: geocodificar o endere√ßo digitado
                try {
                    const geocoder = new google.maps.Geocoder();
                    const geocodeResult = await new Promise((resolve, reject) => {
                        geocoder.geocode({ 'address': locationAddress }, (results, status) => {
                            if (status === 'OK') {
                                resolve(results);
                            } else {
                                reject(new Error('A geocodifica√ß√£o falhou: ' + status));
                            }
                        });
                    });
                    const location = geocodeResult[0].geometry.location;
                    coordinates = {
                        latitude: location.lat(),
                        longitude: location.lng()
                    };
                } catch (geoError) {
                    formStatus.textContent = 'Erro ao localizar o endere√ßo: ' + geoError.message;
                    formStatus.style.color = 'red';
                    return;
                }
            }
            if (!coordinates || !coordinates.latitude || !coordinates.longitude) {
                formStatus.textContent = 'Coordenadas n√£o encontradas. Selecione um local no mapa ou digite um endere√ßo v√°lido.';
                formStatus.style.color = 'red';
                return;
            }

            try {
                const user = firebase.auth().currentUser;
                let imageUrl = '';
                if (imageFile) {
                    const fileName = `${user.uid}_${Date.now()}_${imageFile.name}`;
                    const storageRef = firebase.storage().ref();
                    const imageRef = storageRef.child(`locations/${fileName}`);
                    const snapshot = await imageRef.put(imageFile);
                    imageUrl = await snapshot.ref.getDownloadURL();
                }

                const newLocation = {
                    name: locationName,
                    address: locationAddress,
                    type: locationType,
                    features: selectedFeatures,
                    imageUrl: imageUrl,
                    location: coordinates,
                    rating: 0,
                    reviewCount: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    addedBy: user.uid,
                    addedByName: user.displayName || user.email
                };

                // Salvar os dados no Firestore
                // Gera um ID seguro: nome_do_local
                const safeDocId = locationName.replace(/[.#$/\[\]]/g, '_');
                await firebase.firestore().collection('accessibleLocations').doc(safeDocId).set(newLocation);

                formStatus.textContent = 'Local adicionado com sucesso!';
                formStatus.style.color = 'green';

                addLocationForm.reset();
                setTimeout(() => {
                    modal.style.display = 'none';
                    formStatus.textContent = '';
                    fetchAllLocations();
                }, 1500);

            } catch (error) {
                console.error('Erro ao adicionar local:', error);
                formStatus.textContent = 'Erro ao salvar o local: ' + (error.message || error);
                formStatus.style.color = 'red';
            }
        });

        // --- Fun√ß√µes do Mapa do Google ---

        function loadGoogleMapsScriptAccessible() {
            if (document.getElementById('google-maps-script-accessible')) return;
            const script = document.createElement('script');
            script.id = 'google-maps-script-accessible';
            script.src = `https://maps.googleapis.com/maps/api/js?key=${window.ENV.GOOGLE_MAPS_API_KEY}&libraries=places&callback=initAccessibleMap`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
        window.accessibleMap = undefined;
        window.accessibleMapMarkers = [];

        function initAccessibleMap() {
            const darkMapStyles = [
                { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                { elementType: "labels.text.fill", stylers: [{ color: "#ffffff" }] },
                { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
                { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
                { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#263c3f" }] },
                { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#6b9a76" }] },
                { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
                { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
                { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
                { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] },
                { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }] },
                { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#f3d19c" }] },
                { featureType: "transit", elementType: "geometry", stylers: [{ color: "#2f3948" }] },
                { featureType: "transit.station", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
                { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
                { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#ffffff" }] },
                { featureType: "water", elementType: "labels.text.stroke", stylers: [{ color: "#17263c" }] }
            ];
            const lightMapStyles = [];
            document.removeEventListener('themechange', window._wacs_accessible_map_theme_listener);
            window._wacs_accessible_map_theme_listener = function() {
                if (window.accessibleMap) {
                    const isDark = document.body.classList.contains('dark-theme');
                    window.accessibleMap.setOptions({ styles: isDark ? darkMapStyles : lightMapStyles });
                }
            };
            document.addEventListener('themechange', window._wacs_accessible_map_theme_listener);
            const mapContainer = document.querySelector('.map-container');
            if (mapContainer) {
                mapContainer.innerHTML = '';
                const mapOptions = {
                    center: { lat: -24.4874, lng: -47.8446 },
                    zoom: 14,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    mapTypeControl: true,
                    streetViewControl: false,
                    fullscreenControl: true
                };
                window.accessibleMap = new google.maps.Map(mapContainer, mapOptions);
                const isDark = document.body.classList.contains('dark-theme');
                window.accessibleMap.setOptions({ styles: isDark ? darkMapStyles : lightMapStyles });
                
                // Carrega todos os locais do Firebase ao iniciar o mapa
                fetchAllLocations();
            }
        }

        /**
         * Busca todos os locais do Firebase e armazena na vari√°vel global.
         */
        function fetchAllLocations() {
            if (!firebase || !firebase.firestore) {
                console.error("Firebase n√£o est√° configurado.");
                return;
            }
            firebase.firestore().collection('accessibleLocations').get().then(async (querySnapshot) => {
                allLocationsData = [];
                const locationsById = {};
                querySnapshot.forEach((doc) => {
                    const data = { id: doc.id, ...doc.data() };
                    allLocationsData.push(data);
                    locationsById[data.name] = data; // indexa por nome para facilitar
                });
                // Busca todas as avalia√ß√µes
                const reviewsSnapshot = await firebase.firestore().collection('reviews').get();
                // Agrupa avalia√ß√µes por local
                const reviewsByLocation = {};
                reviewsSnapshot.forEach((doc) => {
                    const review = doc.data();
                    const locId = review.locationId;
                    if (!reviewsByLocation[locId]) reviewsByLocation[locId] = [];
                    reviewsByLocation[locId].push(review);
                });
                // Calcula m√©dia e quantidade de avalia√ß√µes para cada local
                allLocationsData.forEach(loc => {
                    const reviews = reviewsByLocation[loc.name] || [];
                    if (reviews.length > 0) {
                        const avg = reviews.reduce((sum, r) => sum + (r.rating || 0), 0) / reviews.length;
                        loc.rating = Math.round(avg * 10) / 10;
                        loc.reviewCount = reviews.length;
                    } else {
                        loc.rating = 0;
                        loc.reviewCount = 0;
                    }
                });
                // Renderiza os cards e marcadores iniciais
                filterAndRender();
            }).catch((error) => {
                console.error('Erro ao carregar locais do Firebase:', error);
                locationsList.innerHTML = '<p style="text-align: center; width: 100%;">Erro ao carregar locais. Tente novamente mais tarde.</p>';
            });
        }

        /**
         * Carrega (ou recarrega) os marcadores no mapa com base nos locais fornecidos.
         */
        function loadMarkersForAccessibleMap(locations) {
            if (!window.accessibleMap) return;
            
            // Limpa marcadores antigos
            window.accessibleMapMarkers.forEach(marker => marker.setMap(null));
            window.accessibleMapMarkers = [];

            if (!locations || locations.length === 0) {
                return; // N√£o adiciona marcadores se n√£o houver locais
            }

            const bounds = new google.maps.LatLngBounds();
            
            locations.forEach((data) => {
                if (data.location) {
                    const position = {
                        lat: data.location.latitude,
                        lng: data.location.longitude
                    };
                    const marker = new google.maps.Marker({
                        position: position,
                        map: window.accessibleMap,
                        title: data.name,
                        animation: google.maps.Animation.DROP
                    });
                    
                    const rating = data.rating || 0;
                    const reviewCount = data.reviewCount || 0;
                    const imageUrl = data.imageUrl || data.image || data.photoUrl || '';
                    
                    const ratingStars = getRatingStars(rating);

                    const isDark = document.body.classList.contains('dark-theme');
                    const infoTextColor = isDark ? '#fff' : '#222';
                    const infowindow = new google.maps.InfoWindow({
                        content: `
                            <div class='map-info-window' style='color: ${infoTextColor}; max-width: 280px;'>
                                <h3 style='color: ${infoTextColor}; margin-bottom: 8px;'>${data.name}</h3>
                                ${imageUrl ? `<img src="${imageUrl}" alt="Foto de ${data.name}" style="width:100%;height:120px;object-fit:cover;border-radius:8px;margin-bottom:8px;" onerror="this.style.display='none'">` : ''}
                                <p style='margin: 4px 0;'><strong>Endere√ßo:</strong> ${data.address}</p>
                                <p style='margin: 4px 0;'><strong>Recursos:</strong> ${(data.features || []).join(', ')}</p>
                                <div style='margin-top:8px;'>
                                    ${ratingStars}
                                    <span style='margin-left:6px;font-size:13px;'>
                                        ${rating.toFixed(1)} (${reviewCount} ${reviewCount === 1 ? 'avalia√ß√£o' : 'avalia√ß√µes'})
                                    </span>
                                </div>
                            </div>
                        `
                    });
                    marker.addListener('click', function() {
                        infowindow.open(window.accessibleMap, marker);
                    });
                    window.accessibleMapMarkers.push(marker);
                    bounds.extend(position);
                }
            });

            if (!bounds.isEmpty()) {
                window.accessibleMap.fitBounds(bounds);
                const listener = google.maps.event.addListener(window.accessibleMap, 'idle', function() {
                    if (window.accessibleMap.getZoom() > 16) {
                        window.accessibleMap.setZoom(16);
                    }
                    google.maps.event.removeListener(listener);
                });
            }
        }

        // --- Inicializa√ß√£o ---
        if (window.ENV && window.ENV.GOOGLE_MAPS_API_KEY) {
            loadGoogleMapsScriptAccessible();
        } else {
            window.addEventListener('DOMContentLoaded', function() {
                if (window.ENV && window.ENV.GOOGLE_MAPS_API_KEY) {
                    loadGoogleMapsScriptAccessible();
                } else {
                    console.error('Google Maps API key n√£o encontrada nas vari√°veis de ambiente');
                }
            });
        }

        // --- Bot√£o de Avalia√ß√£o ---
        document.getElementById('evaluateLocationBtn').addEventListener('click', function() {
            // Verifica se o usu√°rio est√° logado
            if (firebase.auth().currentUser) {
                // Abre o modal de avalia√ß√£o
                openEvaluationModal();
            } else {
                // Se n√£o estiver logado, redireciona para o login
                alert('Voc√™ precisa estar logado para avaliar locais. Redirecionando para o login...');
                window.location.href = '../wacs_antigo/login/login.html';
            }
        });

        // --- Fun√ß√£o para avaliar local espec√≠fico ---
        window.evaluateLocation = function(locationName, locationAddress) {
            // Verifica se o usu√°rio est√° logado
            if (firebase.auth().currentUser) {
                // Abre o modal de avalia√ß√£o com os dados do local
                openEvaluationModal(locationName, locationAddress);
            } else {
                // Se n√£o estiver logado, redireciona para o login
                alert('Voc√™ precisa estar logado para avaliar locais. Redirecionando para o login...');
                window.location.href = '../wacs_antigo/login/login.html';
            }
        };

        // --- Fun√ß√µes do Modal de Avalia√ß√£o ---
        const evaluationModal = document.getElementById('evaluationModal');
        const closeEvaluationModalBtn = document.getElementById('closeEvaluationModalBtn');
        const cancelEvaluationBtn = document.getElementById('cancelEvaluationBtn');
        const evaluationForm = document.getElementById('evaluationForm');
        const evalRatingStars = document.getElementById('evalRatingStars');
        const evalRatingInput = document.getElementById('evalRating');

        // Estado das avalia√ß√µes (deve vir antes de tudo)
        const featureRatings = { cadeira_rodas: 0, rampa: 0, elevador: 0, banheiro: 0 };

        // Fun√ß√£o para abrir o modal com nome/endere√ßo
        function openEvaluationModal(locationName = '', locationAddress = '') {
            const input = document.getElementById('evalLocalName');
            const readonly = document.getElementById('evalLocalNameReadonly');
            const suggestions = document.getElementById('evalLocalNameSuggestions');
            if (locationName) {
                // Se vier nome, mostrar campo readonly
                input.style.display = 'none';
                suggestions.innerHTML = '';
                readonly.style.display = 'block';
                readonly.textContent = locationName;
                input.value = locationName;
                input.setAttribute('data-readonly', '1');
            } else {
                // Se n√£o vier nome, mostrar input edit√°vel com autocomplete
                input.style.display = 'block';
                readonly.style.display = 'none';
                input.value = '';
                input.removeAttribute('data-readonly');
            }
            document.getElementById('evalLocalAddress').textContent = locationAddress || '';
            // Limpa estrelas
            for (const feature of ['cadeira_rodas','rampa','elevador','banheiro']) {
                renderStars(feature, 0);
            }
            document.getElementById('evalComments').value = '';
            document.getElementById('evaluationFormStatus').textContent = '';
            document.getElementById('evaluationModal').style.display = 'block';
        }

        // Renderiza estrelas para cada recurso
        function renderStars(feature, value) {
            const container = document.querySelector('.eval-feature-stars[data-feature="'+feature+'"]');
            container.innerHTML = '';
            for (let i=1; i<=5; i++) {
                const star = document.createElement('i');
                star.className = 'fas fa-star star'+(i<=value?' active':'');
                star.dataset.value = i;
                star.addEventListener('mouseenter', () => highlightStars(feature, i));
                star.addEventListener('mouseleave', () => highlightStars(feature, 0));
                star.addEventListener('click', () => setFeatureRating(feature, i));
                container.appendChild(star);
            }
        }
        function setFeatureRating(feature, value) {
            featureRatings[feature] = value;
            renderStars(feature, value);
        }
        function highlightStars(feature, value) {
            const container = document.querySelector('.eval-feature-stars[data-feature="'+feature+'"]');
            const stars = container.querySelectorAll('.star');
            stars.forEach((star, idx) => {
                if (value && idx < value) {
                    star.classList.add('hovered');
                } else {
                    star.classList.remove('hovered');
                }
            });
        }
        // Inicializa estrelas
        for (const feature of ['cadeira_rodas','rampa','elevador','banheiro']) {
            renderStars(feature, 0);
        }
        // Fechar modal
        document.getElementById('closeEvaluationModalBtn').onclick = () => {
            document.getElementById('evaluationModal').style.display = 'none';
        };
        window.addEventListener('click', (event) => {
            if (event.target == document.getElementById('evaluationModal')) {
                document.getElementById('evaluationModal').style.display = 'none';
            }
        });
        // Submiss√£o do formul√°rio
        document.getElementById('evaluationForm').onsubmit = async function(e) {
            e.preventDefault();
            const formStatus = document.getElementById('evaluationFormStatus');
            const input = document.getElementById('evalLocalName');
            let localName = input.value.trim();
            // Se for readonly, pega o valor do input (que j√° est√° preenchido)
            if (input.getAttribute('data-readonly') === '1') {
                // N√£o precisa validar, pois j√° veio de um card
            } else {
                // Valida√ß√£o: s√≥ permite se o nome estiver no banco
                if (!allLocationNames.includes(localName)) {
                    formStatus.textContent = 'Selecione um local v√°lido da lista.';
                    formStatus.style.color = 'red';
                    return;
                }
            }
            formStatus.textContent = 'Salvando avalia√ß√£o...';
            formStatus.style.color = '#4A90E2';
            try {
                // Pega dados do usu√°rio logado
                const user = firebase.auth().currentUser;
                let photoURL = '';
                if (user && user.photoURL) {
                    photoURL = user.photoURL;
                }
                // Calcula m√©dia das estrelas dos recursos
                const ratingsArr = Object.values(featureRatings);
                const rating = ratingsArr.length > 0 ? (ratingsArr.reduce((a, b) => a + b, 0) / ratingsArr.length) : 0;
                // Monta o objeto conforme solicitado
                const reviewData = {
                    comment: document.getElementById('evalComments').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    featureRatings: {
                        ramp: featureRatings.rampa,
                        wheelchair: featureRatings.cadeira_rodas,
                        elevator: featureRatings.elevador,
                        bathroom: featureRatings.banheiro
                    },
                    locationId: localName,
                    photoURL: photoURL,
                    rating: Math.round(rating * 10) / 10, // arredonda para 1 casa decimal
                    userId: user ? user.uid : '',
                    userName: user ? (user.displayName || user.email) : ''
                };
                await firebase.firestore().collection('reviews').add(reviewData);
                formStatus.textContent = 'Avalia√ß√£o salva com sucesso!';
                formStatus.style.color = 'green';
                setTimeout(() => {
                    document.getElementById('evaluationModal').style.display = 'none';
                    formStatus.textContent = '';
                }, 1800);
            } catch (error) {
                formStatus.textContent = 'Erro ao salvar avalia√ß√£o: ' + error.message;
                formStatus.style.color = 'red';
            }
        };

        // --- Lista global de nomes de locais ---
        let allLocationNames = [];

        // Buscar nomes dos locais ao carregar a p√°gina
        async function fetchAllLocationNames() {
            if (!firebase || !firebase.firestore) return;
            try {
                const snapshot = await firebase.firestore().collection('accessibleLocations').get();
                allLocationNames = snapshot.docs.map(doc => doc.data().name).filter(Boolean);
            } catch (e) {
                allLocationNames = [];
            }
        }
        fetchAllLocationNames();

        // --- Autocomplete no input do modal de avalia√ß√£o ---
        const evalLocalNameInput = document.getElementById('evalLocalName');
        const suggestionsContainer = document.getElementById('evalLocalNameSuggestions');

        if (evalLocalNameInput && suggestionsContainer) {
            evalLocalNameInput.addEventListener('input', function() {
                const value = this.value.trim().toLowerCase();
                suggestionsContainer.innerHTML = '';
                if (!value || allLocationNames.length === 0) return;
                const filtered = allLocationNames.filter(name => name.toLowerCase().includes(value));
                if (filtered.length === 0) return;
                const list = document.createElement('div');
                list.style.position = 'absolute';
                list.style.background = 'var(--card-bg, #222)';
                list.style.border = '1px solid var(--border-color, #444)';
                list.style.width = '100%';
                list.style.zIndex = '1001';
                list.style.maxHeight = '180px';
                list.style.overflowY = 'auto';
                filtered.forEach(name => {
                    const item = document.createElement('div');
                    item.textContent = name;
                    item.style.padding = '8px';
                    item.style.cursor = 'pointer';
                    item.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        evalLocalNameInput.value = name;
                        suggestionsContainer.innerHTML = '';
                    });
                    list.appendChild(item);
                });
                suggestionsContainer.appendChild(list);
            });
            // Esconde sugest√µes ao perder o foco
            evalLocalNameInput.addEventListener('blur', function() {
                setTimeout(() => { suggestionsContainer.innerHTML = ''; }, 150);
            });
        }

        // --- Fun√ß√£o para mostrar todas avalia√ß√µes de um local ---
        window.showAllReviewsModal = function(locationName) {
            const modal = document.getElementById('allReviewsModal');
            const modalTitle = document.getElementById('allReviewsModalTitle');
            const modalContent = document.getElementById('allReviewsModalContent');
            modalTitle.textContent = `Avalia√ß√µes de "${locationName}"`;
            modalContent.innerHTML = '<p style="text-align:center;">Carregando avalia√ß√µes...</p>';
            modal.style.display = 'block';
            // Buscar avalia√ß√µes do banco (sem orderBy para evitar erro de campo ausente)
            firebase.firestore().collection('reviews')
                .where('locationId', '==', locationName)
                .get()
                .then((querySnap) => {
                    if (querySnap.empty) {
                        modalContent.innerHTML = '<p style="text-align:center;color:#aaa;">Nenhuma avalia√ß√£o encontrada para este local.</p>';
                        return;
                    }
                    let html = '';
                    // Fun√ß√£o para pegar iniciais
                    function getInitials(name) {
                        if (!name) return '?';
                        const parts = name.trim().split(' ');
                        if (parts.length === 1) return parts[0][0].toUpperCase();
                        return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
                    }
                    // Fun√ß√£o auxiliar para montar o card da avalia√ß√£o
                    async function renderReviewCard(r) {
                        const nome = r.userName || 'Usu√°rio';
                        const data = r.createdAt ? (r.createdAt.toDate ? r.createdAt.toDate() : new Date(r.createdAt)) : null;
                        let photoURL = r.photoURL;
                        // Se n√£o houver photoURL, tenta buscar na cole√ß√£o users
                        if (!photoURL && r.userId) {
                            try {
                                const userDoc = await firebase.firestore().collection('users').doc(r.userId).get();
                                if (userDoc.exists) {
                                    const userData = userDoc.data();
                                    photoURL = userData.photoURL || userData.photo || '';
                                }
                            } catch (e) { /* ignora erro */ }
                        }
                        let avatarHtml = '';
                        if (photoURL) {
                            avatarHtml = `<img src="${photoURL}" alt="Avatar" style="width:48px;height:48px;border-radius:50%;object-fit:cover;flex-shrink:0;border:2px solid #4A90E2;background:#222;">`;
                        } else {
                            const initials = getInitials(nome);
                            avatarHtml = `<div style="width:48px;height:48px;border-radius:50%;background:#4A90E2;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:1.2em;flex-shrink:0;">${initials}</div>`;
                        }
                        return `
                            <div style='display:flex;gap:14px;padding:18px 0 14px 0;border-bottom:1px solid #333;'>
                                ${avatarHtml}
                                <div style="flex:1;">
                                    <div style="display:flex;align-items:center;gap:8px;">
                                        <span style="font-weight:600;font-size:1.08em;">${nome}</span>
                                        ${data ? `<span style="font-size:0.93em;color:#aaa;">${data.toLocaleDateString('pt-BR')}</span>` : ''}
                                    </div>
                                    <div style="margin:2px 0 6px 0;">
                                        <span style='color:#ffd700;'>${getRatingStars(r.rating)}</span>
                                        <b style='margin-left:6px;'>${r.rating ? r.rating.toFixed(1) : '-'}</b>
                                    </div>
                                    ${r.comment ? `<div style='font-size:1.01em;margin-top:2px;line-height:1.5;'><i class='fas fa-comment'></i> ${r.comment}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }
                    // Monta todos os cards de avalia√ß√£o de forma ass√≠ncrona
                    (async () => {
                        const cards = [];
                        for (const doc of querySnap.docs) {
                            const r = doc.data();
                            cards.push(await renderReviewCard(r));
                        }
                        modalContent.innerHTML = cards.join('');
                    })();
                })
                .catch(() => {
                    modalContent.innerHTML = '<p style="text-align:center;color:#f66;">Erro ao buscar avalia√ß√µes.</p>';
                });
        };
        // Fechar modal de avalia√ß√µes
        document.getElementById('closeAllReviewsModalBtn').onclick = () => {
            document.getElementById('allReviewsModal').style.display = 'none';
        };
        window.addEventListener('click', (event) => {
            if (event.target == document.getElementById('allReviewsModal')) {
                document.getElementById('allReviewsModal').style.display = 'none';
            }
        });
    </script>
</body>
</html> 